<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ‰¹ç®¡ç† - æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pagination.css') }}">
</head>
<body class="dashboard-page">
    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</h2>
        </div>
        <div class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        <span class="nav-text">ä»ªè¡¨æ¿</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/expenses" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <span class="nav-text">æŠ¥é”€ç”³è¯·</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/approvals" class="nav-link active">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                        <span class="nav-text">å®¡æ‰¹ç®¡ç†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/reports" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 9h6v6H9z"/>
                            <path d="M9 1v2"/>
                            <path d="M15 1v2"/>
                            <path d="M9 21v2"/>
                            <path d="M15 21v2"/>
                            <path d="M1 9h2"/>
                            <path d="M1 15h2"/>
                            <path d="M21 9h2"/>
                            <path d="M21 15h2"/>
                        </svg>
                        <span class="nav-text">æŠ¥è¡¨å¯¼å‡º</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span class="nav-text">ç³»ç»Ÿç®¡ç†</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="topbar-right">
                <button class="notification-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </button>
                
                <div class="divider"></div>
                
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        <span>{{ session.username[0] if session.username else 'U' }}</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <p class="user-name">{{ session.username or 'ç”¨æˆ·' }}</p>
                            <p class="user-email">{{ session.role or 'employee' }}</p>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            ä¸ªäººèµ„æ–™
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/logout" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16,17 21,12 16,7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <main class="page-content">
            <div class="content-header">
                <div class="header-left">
                    <h1 class="page-title">å®¡æ‰¹ç®¡ç†</h1>
                    <p class="page-subtitle">å¤„ç†å¾…å®¡æ‰¹çš„æŠ¥é”€ç”³è¯·å’ŒæŸ¥çœ‹å®¡æ‰¹å†å²</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="batchApprove()">
                        æ‰¹é‡é€šè¿‡
                    </button>
                </div>
            </div>

            <!-- å®¡æ‰¹ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon text-orange">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="pendingApprovals">0</div>
                        <div class="stat-title">å¾…å®¡æ‰¹</div>
                        <p class="stat-change">éœ€è¦å¤„ç†</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon text-green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="approvedToday">0</div>
                        <div class="stat-title">ä»Šæ—¥å·²å®¡æ‰¹</div>
                        <p class="stat-change">ä»Šæ—¥å¤„ç†</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon text-blue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalApprovals">0</div>
                        <div class="stat-title">æ€»å®¡æ‰¹æ•°</div>
                        <p class="stat-change">å…¨éƒ¨è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- é«˜çº§ç­›é€‰ -->
            <div id="advancedFilters"></div>

            <!-- å®¡æ‰¹åˆ—è¡¨ -->
            <div class="list-container">
                <div class="list-header">
                    <div class="batch-select">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">å…¨é€‰</label>
                    </div>
                    <div class="sort-options">
                        <select id="sortBy" onchange="loadApprovals()">
                            <option value="created_at">æŒ‰ç”³è¯·æ—¶é—´</option>
                            <option value="amount">æŒ‰é‡‘é¢å¤§å°</option>
                            <option value="title">æŒ‰æ ‡é¢˜</option>
                        </select>
                    </div>
                </div>

                <div class="list-items" id="approvalsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>åŠ è½½ä¸­...</span>
                    </div>
                </div>

                <!-- åˆ†é¡µå®¹å™¨ -->
                <div id="approvalsPagination"></div>

                <!-- ç©ºçŠ¶æ€ -->
                <div id="emptyApprovals" class="empty-state hidden">
                    <div class="empty-icon">âœ…</div>
                    <h3>æš‚æ— å®¡æ‰¹é¡¹ç›®</h3>
                    <p>å½“å‰æ²¡æœ‰éœ€è¦å¤„ç†çš„å®¡æ‰¹ç”³è¯·</p>
                </div>
            </div>
        </main>
    </div>

    <!-- å®¡æ‰¹æ¨¡æ€æ¡† -->
    <div class="modal" id="approvalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å®¡æ‰¹ç”³è¯·</h3>
                <button class="modal-close" onclick="closeApprovalModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="expenseDetails">
                    <!-- æŠ¥é”€è¯¦æƒ…å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
                <div class="form-group">
                    <label for="approvalComment" class="form-label">å®¡æ‰¹æ„è§</label>
                    <textarea id="approvalComment" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">å–æ¶ˆ</button>
                <button class="btn btn-destructive" onclick="rejectExpense()" id="rejectBtn">æ‹’ç»</button>
                <button class="btn btn-primary" onclick="approveExpense()" id="approveBtn">é€šè¿‡</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/advanced-filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
    <script>
        let currentStatus = 'pending';
        let approvals = [];
        let filteredApprovals = [];
        let currentExpenseId = null;
        let advancedFilters = null;
        let approvalsPagination; // åˆ†é¡µç®¡ç†å™¨

        // ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
        
        // ç”¨æˆ·èœå•åˆ‡æ¢
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µï¼ˆä¿ç•™ä½†ä¸ä½¿ç”¨ï¼‰
        function switchTab(status) {
            // é€šè¿‡é«˜çº§ç­›é€‰çš„çŠ¶æ€ç­›é€‰æ¥æ›¿ä»£æ ‡ç­¾é¡µåŠŸèƒ½
            if (advancedFilters) {
                advancedFilters.setFilterValue('status', status === 'all' ? '' : status);
            }
        }

        // åˆå§‹åŒ–é«˜çº§ç­›é€‰
        function initAdvancedFilters() {
            advancedFilters = new AdvancedFilters('advancedFilters', {
                title: 'å®¡æ‰¹ç®¡ç†ç­›é€‰',
                collapsed: false,
                showQuickFilters: true,
                showSearch: true,
                fields: [
                    {
                        key: 'status',
                        label: 'å®¡æ‰¹çŠ¶æ€',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨çŠ¶æ€' },
                            { value: 'pending', label: 'å¾…å®¡æ‰¹' },
                            { value: 'approved', label: 'å·²é€šè¿‡' },
                            { value: 'rejected', label: 'å·²æ‹’ç»' }
                        ]
                    },
                    {
                        key: 'category',
                        label: 'è´¹ç”¨ç±»å‹',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨ç±»å‹' }
                        ]
                    },
                    {
                        key: 'submitter',
                        label: 'ç”³è¯·äºº',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨ç”³è¯·äºº' }
                        ]
                    },
                    {
                        key: 'currency',
                        label: 'è´§å¸ç±»å‹',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨è´§å¸' }
                        ]
                    },
                    {
                        key: 'amount',
                        label: 'é‡‘é¢èŒƒå›´ï¼ˆç¾å…ƒï¼‰',
                        type: 'amountRange'
                    },
                    {
                        key: 'date',
                        label: 'ç”³è¯·æ—¥æœŸ',
                        type: 'dateRange'
                    }
                ],
                quickFilters: [
                    { label: 'å¾…å®¡æ‰¹', filters: { status: 'pending' } },
                    { label: 'å·²é€šè¿‡', filters: { status: 'approved' } },
                    { label: 'å·²æ‹’ç»', filters: { status: 'rejected' } },
                    { label: 'æœ¬å‘¨ç”³è¯·', filters: { date: 'thisWeek' } },
                    { label: 'å¤§é¢ç”³è¯·', filters: { amount: { min: '1000' } } }
                ],
                onFilterChange: (filters) => {
                    applyAdvancedFilters(filters);
                }
            });
            
            // åŠ è½½ç­›é€‰é€‰é¡¹æ•°æ®
            loadFilterOptions();
        }

        // åŠ è½½ç­›é€‰é€‰é¡¹æ•°æ®
        async function loadFilterOptions() {
            try {
                // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½å®¡æ‰¹æ•°æ®ï¼Œå…ˆåŠ è½½
                if (!approvals || approvals.length === 0) {
                    return;
                }
                
                // è·å–å”¯ä¸€çš„åˆ†ç±»
                const categories = [...new Set(approvals.map(item => item.category))].filter(Boolean);
                const categoryOptions = [{ value: '', label: 'å…¨éƒ¨ç±»å‹' }]
                    .concat(categories.map(cat => ({ value: cat, label: cat })));
                
                // è·å–å”¯ä¸€çš„ç”³è¯·äºº
                const submitters = [...new Set(approvals.map(item => item.submitter))].filter(Boolean);
                const submitterOptions = [{ value: '', label: 'å…¨éƒ¨ç”³è¯·äºº' }]
                    .concat(submitters.map(sub => ({ value: sub, label: sub })));
                
                // è·å–å”¯ä¸€çš„è´§å¸
                const currencies = [...new Set(approvals.map(item => item.currency))].filter(Boolean);
                const currencyOptions = [{ value: '', label: 'å…¨éƒ¨è´§å¸' }]
                    .concat(currencies.map(cur => ({ value: cur, label: cur })));
                
                // ç¡®ä¿é«˜çº§ç­›é€‰å™¨å·²åˆå§‹åŒ–
                if (advancedFilters) {
                    // æ›´æ–°ç­›é€‰é€‰é¡¹
                    advancedFilters.updateFieldOptions('category', categoryOptions);
                    advancedFilters.updateFieldOptions('submitter', submitterOptions);
                    advancedFilters.updateFieldOptions('currency', currencyOptions);
                }
                
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }

        // åº”ç”¨é«˜çº§ç­›é€‰
        function applyAdvancedFilters(filters) {
            filteredApprovals = approvals.filter(approval => {
                // çŠ¶æ€ç­›é€‰
                if (filters.status && approval.status !== filters.status) {
                    return false;
                }
                
                // åˆ†ç±»ç­›é€‰
                if (filters.category && approval.category !== filters.category) {
                    return false;
                }
                
                // ç”³è¯·äººç­›é€‰
                if (filters.submitter && approval.submitter !== filters.submitter) {
                    return false;
                }
                
                // è´§å¸ç­›é€‰
                if (filters.currency && approval.currency !== filters.currency) {
                    return false;
                }
                
                // é‡‘é¢èŒƒå›´ç­›é€‰ï¼ˆä½¿ç”¨ç¾å…ƒé‡‘é¢ï¼‰
                if (filters.amount) {
                    const usdAmount = parseFloat(approval.usd_amount);
                    if (filters.amount.min !== undefined && usdAmount < parseFloat(filters.amount.min)) {
                        return false;
                    }
                    if (filters.amount.max !== undefined && usdAmount > parseFloat(filters.amount.max)) {
                        return false;
                    }
                }
                
                // æ—¥æœŸèŒƒå›´ç­›é€‰
                if (filters.date) {
                    const approvalDate = new Date(approval.created_at);
                    if (filters.date.start && approvalDate < new Date(filters.date.start)) {
                        return false;
                    }
                    if (filters.date.end && approvalDate > new Date(filters.date.end + 'T23:59:59')) {
                        return false;
                    }
                }
                
                // æœç´¢ç­›é€‰
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    const searchFields = [
                        approval.title,
                        approval.description,
                        approval.category,
                        approval.submitter
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderApprovals(filteredApprovals);
            updateStats();
        }

        // åŠ è½½å®¡æ‰¹æ•°æ® - æ”¯æŒåˆ†é¡µ
        async function loadApprovals(paginationParams = null) {
            const list = document.getElementById('approvalsList');
            const emptyState = document.getElementById('emptyApprovals');
            
            list.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><span>åŠ è½½ä¸­...</span></div>';
            emptyState.classList.add('hidden');
            
            try {
                let url = '/api/expenses';
                
                // æ·»åŠ åˆ†é¡µå‚æ•°
                if (paginationParams) {
                    url += `?page=${paginationParams.page}&per_page=${paginationParams.perPage}`;
                }
                
                const response = await api.get(url);
                
                // åˆ¤æ–­å“åº”æ ¼å¼ï¼šæ–°çš„åˆ†é¡µæ ¼å¼ vs æ—§çš„æ•°ç»„æ ¼å¼
                if (response.data && response.pagination) {
                    // æ–°çš„åˆ†é¡µæ ¼å¼
                    approvals = response.data;
                    
                    // æ›´æ–°åˆ†é¡µUI
                    if (!approvalsPagination) {
                        // åˆå§‹åŒ–åˆ†é¡µç®¡ç†å™¨
                        approvalsPagination = new PaginationManager('approvalsPagination', {
                            perPage: 20,
                            onPageChange: (params) => {
                                console.log('ğŸ“„ å®¡æ‰¹é¡µé¢å˜æ›´:', params);
                                loadApprovals(params);
                            }
                        });
                    }
                    approvalsPagination.update(response.pagination);
                } else {
                    // å‘åå…¼å®¹æ—§æ ¼å¼
                    approvals = response;
                    // éšè—åˆ†é¡µUI
                    if (approvalsPagination) {
                        approvalsPagination.reset();
                    }
                }
                
                filteredApprovals = approvals;
                
                if (approvals.length === 0) {
                    list.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    // éšè—åˆ†é¡µ
                    if (approvalsPagination) {
                        approvalsPagination.reset();
                    }
                } else {
                    renderApprovals(approvals);
                    emptyState.classList.add('hidden');
                }
                
                // åŠ è½½ç­›é€‰é€‰é¡¹æ•°æ®ï¼ˆåªåœ¨é¦–æ¬¡åŠ è½½æ—¶ï¼‰
                if (!paginationParams) {
                    loadFilterOptions();
                }
                
                updateStats();
            } catch (error) {
                console.error('åŠ è½½å®¡æ‰¹æ•°æ®å¤±è´¥:', error);
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>åŠ è½½å¤±è´¥</h3><p>æ— æ³•åŠ è½½å®¡æ‰¹æ•°æ®ï¼Œè¯·ç¨åé‡è¯•</p><button class="btn btn-primary btn-sm" onclick="loadApprovals()">é‡è¯•</button></div>';
            }
        }

        // æ¸²æŸ“å®¡æ‰¹åˆ—è¡¨
        function renderApprovals(data) {
            const list = document.getElementById('approvalsList');
            
            const html = data.map(approval => {
                const actionButtons = approval.status === 'pending' ? `
                    <button class="btn btn-primary btn-sm" onclick="showApprovalModal(${approval.id})">å®¡æ‰¹</button>
                ` : approval.status === 'approved' ? `
                    <button class="btn btn-secondary btn-sm" onclick="viewDetails(${approval.id})">æŸ¥çœ‹</button>
                ` : `
                    <button class="btn btn-secondary btn-sm" onclick="viewDetails(${approval.id})">æŸ¥çœ‹</button>
                    <button class="btn btn-primary btn-sm" onclick="showApprovalModal(${approval.id})">é‡æ–°å®¡æ‰¹</button>
                `;
                
                return `
                    <div class="list-item animate-fadeIn">
                        <div class="item-checkbox">
                            <input type="checkbox" value="${approval.id}" class="approval-select">
                        </div>
                        <div class="item-info">
                            <h4 class="item-title">${approval.title}</h4>
                            <div class="item-meta">
                                <span>ç±»å‹ï¼š${approval.category}</span>
                                <span>ç”³è¯·äººï¼š${approval.submitter}</span>
                                <span>æ—¶é—´ï¼š${utils.formatDate(approval.created_at)}</span>
                            </div>
                            <p class="item-description">${approval.description || 'æ— è¯¦ç»†è¯´æ˜'}</p>
                        </div>
                        <div class="item-amount">
                            <div class="amount-display">
                                <span class="amount">${utils.formatMultiCurrencyAmount(approval.amount, approval.currency, approval.usd_amount)}</span>
                                ${approval.currency !== 'USD' ? `<span class="exchange-info">æ±‡ç‡: ${approval.exchange_rate}</span>` : ''}
                            </div>
                        </div>
                        <div class="item-status">
                            <span class="badge ${utils.getStatusClass(approval.status)}">${utils.getStatusText(approval.status)}</span>
                        </div>
                        <div class="item-actions">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            list.innerHTML = html;
        }

        // æ˜¾ç¤ºå®¡æ‰¹æ¨¡æ€æ¡†
        function showApprovalModal(expenseId) {
            currentExpenseId = expenseId;
            const expense = (filteredApprovals.length > 0 ? filteredApprovals : approvals).find(e => e.id == expenseId);
            if (!expense) return;
            
            // å¡«å……æŠ¥é”€è¯¦æƒ…
            document.getElementById('expenseDetails').innerHTML = `
                <div style="background: var(--muted); padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--foreground);">æŠ¥é”€ç”³è¯·è¯¦æƒ…</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                        <div><strong>ç”³è¯·æ ‡é¢˜ï¼š</strong>${expense.title}</div>
                        <div><strong>è´¹ç”¨ç±»å‹ï¼š</strong>${expense.category}</div>
                        <div><strong>æŠ¥é”€é‡‘é¢ï¼š</strong>${utils.formatMultiCurrencyAmount(expense.amount, expense.currency, expense.usd_amount)}</div>
                        ${expense.currency !== 'USD' ? `<div><strong>æ±‡ç‡ï¼š</strong>${expense.exchange_rate}</div>` : ''}
                        <div><strong>ç”³è¯·äººï¼š</strong>${expense.submitter}</div>
                        <div><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${utils.formatDate(expense.created_at)}</div>
                        <div><strong>è´¹ç”¨å‘ç”Ÿæ—¥æœŸï¼š</strong>${utils.formatDate(expense.expense_date)}</div>
                    </div>
                    ${expense.description ? `<div style="margin-top: 12px;"><strong>è´¹ç”¨è¯´æ˜ï¼š</strong><br>${expense.description}</div>` : ''}
                    
                    <!-- é™„ä»¶ä¿¡æ¯ -->
                    ${expense.files && expense.files.length > 0 ? `
                        <div style="margin-top: 16px;">
                            <strong>æŠ¥é”€å‡­è¯ï¼ˆ${expense.files.length}ä¸ªæ–‡ä»¶ï¼‰ï¼š</strong>
                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                                ${expense.files.map(file => `
                                    <a href="/uploads/${file.filename}" target="_blank" class="btn btn-sm btn-secondary">
                                        ğŸ“ ${file.original_filename}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<div style="margin-top: 12px; color: var(--destructive);"><strong>âš ï¸ æœªä¸Šä¼ é™„ä»¶</strong></div>'}
                </div>
            `;
            
            // å¦‚æœæ˜¯å·²å®¡æ‰¹çš„ï¼Œæ˜¾ç¤ºä¹‹å‰çš„å®¡æ‰¹æ„è§
            if (expense.approval_comment) {
                document.getElementById('approvalComment').value = expense.approval_comment;
            } else {
                document.getElementById('approvalComment').value = '';
            }
            
            document.getElementById('approvalModal').classList.add('show');
        }

        // å…³é—­å®¡æ‰¹æ¨¡æ€æ¡†
        function closeApprovalModal() {
            document.getElementById('approvalModal').classList.remove('show');
            currentExpenseId = null;
        }

        // é€šè¿‡å®¡æ‰¹
        async function approveExpense() {
            if (!currentExpenseId) return;
            
            const approveBtn = document.getElementById('approveBtn');
            const originalText = approveBtn.textContent;
            
            try {
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<div class="loading-spinner"></div> å¤„ç†ä¸­...';
                
                const comment = document.getElementById('approvalComment').value;
                const response = await api.post(`/api/expenses/${currentExpenseId}/approve`, {
                    comment: comment
                });
                
                if (response.success) {
                    utils.showMessage('å®¡æ‰¹é€šè¿‡ï¼', 'success');
                    closeApprovalModal();
                    loadApprovals();
                } else {
                    utils.showMessage(response.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                utils.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                approveBtn.disabled = false;
                approveBtn.textContent = originalText;
            }
        }

        // æ‹’ç»å®¡æ‰¹
        async function rejectExpense() {
            if (!currentExpenseId) return;
            
            const comment = document.getElementById('approvalComment').value;
            if (!comment.trim()) {
                utils.showMessage('æ‹’ç»ç”³è¯·æ—¶å¿…é¡»å¡«å†™å®¡æ‰¹æ„è§', 'error');
                return;
            }
            
            const rejectBtn = document.getElementById('rejectBtn');
            const originalText = rejectBtn.textContent;
            
            try {
                rejectBtn.disabled = true;
                rejectBtn.innerHTML = '<div class="loading-spinner"></div> å¤„ç†ä¸­...';
                
                const response = await api.post(`/api/expenses/${currentExpenseId}/reject`, {
                    comment: comment
                });
                
                if (response.success) {
                    utils.showMessage('å·²æ‹’ç»ç”³è¯·', 'success');
                    closeApprovalModal();
                    loadApprovals();
                } else {
                    utils.showMessage(response.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                utils.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                rejectBtn.disabled = false;
                rejectBtn.textContent = originalText;
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(id) {
            window.location.href = `/approval/${id}`;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            // ä½¿ç”¨åŸå§‹æ•°æ®è®¡ç®—ç»Ÿè®¡
            const stats = {
                pending: approvals.filter(a => a.status === 'pending').length,
                approved: approvals.filter(a => a.status === 'approved').length,
                rejected: approvals.filter(a => a.status === 'rejected').length,
                total: approvals.length
            };
            
            document.getElementById('pendingApprovals').textContent = stats.pending;
            document.getElementById('approvedToday').textContent = stats.approved;
            document.getElementById('totalApprovals').textContent = stats.total;
        }

        // æ‰¹é‡å®¡æ‰¹
        async function batchApprove() {
            const selected = document.querySelectorAll('.approval-select:checked');
            if (selected.length === 0) {
                utils.showMessage('è¯·é€‰æ‹©è¦å®¡æ‰¹çš„é¡¹ç›®', 'error');
                return;
            }
            
            if (await utils.confirm(`ç¡®å®šè¦æ‰¹é‡é€šè¿‡ ${selected.length} ä¸ªç”³è¯·å—ï¼Ÿ`)) {
                utils.showMessage('æ‰¹é‡å®¡æ‰¹åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°', 'info');
            }
        }

        // å…¨é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.approval-select');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é«˜çº§ç­›é€‰
            initAdvancedFilters();
            
            // åŠ è½½æ•°æ®
            loadApprovals();
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    const dropdown = document.getElementById('userDropdown');
                    dropdown.classList.remove('show');
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('approvalModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApprovalModal();
                }
            });
        });
    </script>
</body>
</html>