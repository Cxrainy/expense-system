<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥é”€ç”³è¯· - æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pagination.css') }}">
</head>
<body class="dashboard-page">
    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</h2>
        </div>
        <div class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        <span class="nav-text">ä»ªè¡¨æ¿</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/expenses" class="nav-link active">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <span class="nav-text">æŠ¥é”€ç”³è¯·</span>
                    </a>
                </li>
                {% if session.role == 'admin' %}
                <li class="nav-item">
                    <a href="/approvals" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                        <span class="nav-text">å®¡æ‰¹ç®¡ç†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/reports" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 9h6v6H9z"/>
                            <path d="M9 1v2"/>
                            <path d="M15 1v2"/>
                            <path d="M9 21v2"/>
                            <path d="M15 21v2"/>
                            <path d="M1 9h2"/>
                            <path d="M1 15h2"/>
                            <path d="M21 9h2"/>
                            <path d="M21 15h2"/>
                        </svg>
                        <span class="nav-text">æŠ¥è¡¨å¯¼å‡º</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                       <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span class="nav-text">ç³»ç»Ÿç®¡ç†</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="topbar-right">
                <button class="notification-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </button>
                
                <div class="divider"></div>
                
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        <span>{{ session.username[0] if session.username else 'U' }}</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <p class="user-name">{{ session.username or 'ç”¨æˆ·' }}</p>
                            <p class="user-email">{{ session.role or 'employee' }}</p>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            ä¸ªäººèµ„æ–™
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="/logout" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16,17 21,12 16,7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <main class="page-content">
            <div class="content-header">
                <div class="header-left">
                    <h1 class="page-title">æŠ¥é”€ç”³è¯·</h1>
                    <p class="page-subtitle">ç®¡ç†æ‚¨çš„æŠ¥é”€ç”³è¯·å’ŒæŸ¥çœ‹ç”³è¯·çŠ¶æ€</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showNewExpenseModal()">
                        æ–°å»ºç”³è¯·
                    </button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon text-blue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalExpenses">0</div>
                        <div class="stat-title">æ€»ç”³è¯·æ•°</div>
                        <p class="stat-change">å…¨éƒ¨è®°å½•</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon text-orange">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="pendingExpenses">0</div>
                        <div class="stat-title">å¾…å®¡æ‰¹</div>
                        <p class="stat-change">éœ€è¦å®¡æ‰¹</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon text-green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="approvedExpenses">0</div>
                        <div class="stat-title">å·²é€šè¿‡</div>
                        <p class="stat-change">å·²å®Œæˆå®¡æ‰¹</p>
                    </div>
                </div>
            </div>

            <!-- é«˜çº§ç­›é€‰ -->
            <div id="advancedFilters"></div>

            <!-- æŠ¥é”€ç”³è¯·åˆ—è¡¨ -->
            <div class="list-container">
                <div class="list-header">
                    <div class="filters-summary" id="filtersSummary">
                        <span>æ˜¾ç¤º <span class="filters-count" id="resultsCount">0</span> æ¡ç»“æœ</span>
                    </div>
                    <div class="sort-options">
                        <select id="sortBy" onchange="loadExpenses()">
                            <option value="created_at">æŒ‰ç”³è¯·æ—¶é—´</option>
                            <option value="amount">æŒ‰é‡‘é¢å¤§å°</option>
                            <option value="title">æŒ‰æ ‡é¢˜</option>
                        </select>
                    </div>
                </div>

                <div class="list-items" id="expensesList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>åŠ è½½ä¸­...</span>
                    </div>
                </div>

                <!-- åˆ†é¡µå®¹å™¨ -->
                <div id="expensesPagination"></div>

                <!-- ç©ºçŠ¶æ€ -->
                <div id="emptyExpenses" class="empty-state hidden">
                    <div class="empty-icon">ğŸ“</div>
                    <h3>æš‚æ— æŠ¥é”€ç”³è¯·</h3>
                    <p>æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æŠ¥é”€ç”³è¯·ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç”³è¯·</p>
                    <button class="btn btn-primary" onclick="showNewExpenseModal()">åˆ›å»ºç”³è¯·</button>
                </div>
            </div>
        </main>
    </div>

    <!-- æ–°å»ºç”³è¯·æ¨¡æ€æ¡† -->
    <div class="modal" id="newExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–°å»ºæŠ¥é”€ç”³è¯·</h3>
                <button class="modal-close" onclick="closeNewExpenseModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="newExpenseForm" onsubmit="return handleFormSubmit(event)">
                    <div class="form-group">
                        <label for="expenseTitle" class="form-label">ç”³è¯·æ ‡é¢˜</label>
                        <input type="text" id="expenseTitle" class="form-input" placeholder="è¯·è¾“å…¥ç”³è¯·æ ‡é¢˜" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseCategory" class="form-label">è´¹ç”¨ç±»å‹</label>
                            <select id="expenseCategory" class="form-select" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <!-- åŠ¨æ€åŠ è½½åˆ†ç±»é€‰é¡¹ -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="expenseCurrency" class="form-label">è´§å¸ç±»å‹</label>
                            <select id="expenseCurrency" class="form-select" required onchange="handleCurrencyChange(false)">
                                <option value="">è¯·é€‰æ‹©</option>
                                <!-- åŠ¨æ€åŠ è½½è´§å¸é€‰é¡¹ -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseAmount" class="form-label">æŠ¥é”€é‡‘é¢</label>
                            <div class="input-group">
                                <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01" min="0" required onchange="calculateUsdAmount()">
                                <span class="input-addon" id="currencySymbol">CNY</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="exchangeRate" class="form-label">
                                æ±‡ç‡ 
                                <span class="form-hint">(å¤šå°‘å•ä½è´§å¸=1ç¾å…ƒ)</span>
                            </label>
                            <input type="number" id="exchangeRate" class="form-input" placeholder="1.0000" step="0.0001" min="0.0001" value="1.0000" required onchange="calculateUsdAmount()">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="currency-conversion" id="currencyConversion">
                            <div class="conversion-info">
                                <span class="conversion-label">ç¾å…ƒé‡‘é¢ï¼š</span>
                                <span class="conversion-amount" id="usdAmount">$ 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDate" class="form-label">è´¹ç”¨å‘ç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="expenseDate" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription" class="form-label">è´¹ç”¨è¯´æ˜ <span style="color: var(--destructive);">*</span></label>
                        <textarea id="expenseDescription" class="form-textarea" placeholder="è¯·è¯¦ç»†è¯´æ˜è´¹ç”¨ç”¨é€”å’Œè¯¦æƒ…" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseFiles" class="form-label">æŠ¥é”€å‡­è¯ <span style="color: var(--destructive);">*</span></label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="expenseFiles" name="files" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx" class="file-input" required>
                            <div class="file-upload-content">
                                <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17,8 12,3 7,8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <p class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æŠ¥é”€å‡­è¯</p>
                                <p class="file-upload-hint">æ”¯æŒ PDFã€å›¾ç‰‡ã€Wordã€Excel ç­‰æ ¼å¼ï¼Œæœ€å¤§ 16MB</p>
                            </div>
                        </div>
                        <div id="fileList" class="file-list"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewExpenseModal()">å–æ¶ˆ</button>
                <button type="submit" form="newExpenseForm" class="btn btn-primary" id="submitBtn">æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-preview.js') }}"></script>
    <script src="{{ url_for('static', filename='js/advanced-filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
    <script>
        let currentStatus = 'all';
        let currentCurrency = 'all'; // è´§å¸ç­›é€‰
        let currentCategory = 'all'; // æ–°å¢ï¼šåˆ†ç±»ç­›é€‰
        let expenses = [];
        let filteredExpenses = []; // æ–°å¢ï¼šç­›é€‰åçš„æ•°æ®
        let selectedFiles = [];
        let currentEditingId = null;
        let advancedFilters; // é«˜çº§ç­›é€‰ç»„ä»¶
        let expensesPagination; // åˆ†é¡µç®¡ç†å™¨

        // åŠ¨æ€åŠ è½½è´§å¸å’Œåˆ†ç±»é€‰é¡¹
        async function loadFormOptions() {
            try {
                // åŠ è½½è´§å¸é€‰é¡¹
                const currencies = await api.get('/api/currencies');
                const currencySelect = document.getElementById('expenseCurrency');
                
                currencies.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.code;
                    option.textContent = `${currency.name} (${currency.code})`;
                    currencySelect.appendChild(option);
                });

                // è®¾ç½®é»˜è®¤è´§å¸å¹¶è§¦å‘æ±‡ç‡æ›´æ–°
                currencySelect.value = 'CNY';
                await handleCurrencyChange();

                // åŠ è½½åˆ†ç±»é€‰é¡¹
                const categories = await api.get('/api/categories');
                const categorySelect = document.getElementById('expenseCategory');
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });

            } catch (error) {
                console.error('åŠ è½½è¡¨å•é€‰é¡¹å¤±è´¥:', error);
                utils.showMessage('åŠ è½½è¡¨å•é€‰é¡¹å¤±è´¥', 'error');
            }
        }

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
        function initFileUpload() {
            const fileInput = document.getElementById('expenseFiles');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileList = document.getElementById('fileList');

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // æ‹–æ”¾äº‹ä»¶
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            const maxSize = 16 * 1024 * 1024; // 16MB
            const allowedTypes = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'xls', 'xlsx'];

            for (let file of files) {
                if (file.size > maxSize) {
                    utils.showMessage(`æ–‡ä»¶ ${file.name} è¶…è¿‡ 16MB é™åˆ¶`, 'error');
                    continue;
                }

                const extension = file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(extension)) {
                    utils.showMessage(`æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ”¯æŒ`, 'error');
                    continue;
                }

                selectedFiles.push(file);
            }

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            const html = selectedFiles.map((file, index) => {
                const size = formatFileSize(file.size);
                const extension = file.name.split('.').pop().toLowerCase();
                const iconClass = getFileIconClass(extension);

                return `
                    <div class="file-item">
                        <div class="file-info">
                            <svg class="file-icon ${iconClass}" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${getFileIconSVG(extension)}
                            </svg>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${size}</div>
                            </div>
                        </div>
                        <button type="button" class="file-remove" onclick="removeFile(${index})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');

            fileList.innerHTML = html;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIconClass(extension) {
            if (['pdf'].includes(extension)) return 'pdf';
            if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) return 'image';
            if (['doc', 'docx'].includes(extension)) return 'document';
            if (['xls', 'xlsx'].includes(extension)) return 'spreadsheet';
            return 'document';
        }

        function getFileIconSVG(extension) {
            if (['pdf'].includes(extension)) {
                return '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/>';
            }
            if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) {
                return '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/>';
            }
            return '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/>';
        }

        // ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
        
        // ç”¨æˆ·èœå•åˆ‡æ¢
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // è´§å¸ç›¸å…³å‡½æ•°
        const currencySymbols = {
            'CNY': 'Â¥',
            'USD': '$',
            'EUR': 'â‚¬',
            'GBP': 'Â£',
            'JPY': 'Â¥',
            'KRW': 'â‚©',
            'HKD': 'HK$',
            'SGD': 'S$',
            'AUD': 'A$',
            'CAD': 'C$'
        };

        // ä¿®æ”¹handleCurrencyChangeå‡½æ•°ä»¥è‡ªåŠ¨å¡«å……é»˜è®¤æ±‡ç‡
        async function handleCurrencyChange(preserveExistingRate = false) {
            const currencySelect = document.getElementById('expenseCurrency');
            const currencySymbol = document.getElementById('currencySymbol');
            const exchangeRateInput = document.getElementById('exchangeRate');
            const selectedCurrency = currencySelect.value;
            
            // æ›´æ–°è´§å¸ç¬¦å·
            currencySymbol.textContent = selectedCurrency;
            
            // å¯ç”¨æ±‡ç‡è¾“å…¥æ¡†ï¼ˆå…è®¸ç”¨æˆ·ä¿®æ”¹ï¼‰
            exchangeRateInput.disabled = false;
            
            // è·å–å¹¶è®¾ç½®è¯¥è´§å¸çš„é»˜è®¤æ±‡ç‡
            if (selectedCurrency) {
                try {
                    const currencies = await api.get('/api/currencies');
                    const selectedCurrencyData = currencies.find(currency => currency.code === selectedCurrency);
                    
                    if (selectedCurrency === 'USD') {
                        // ç¾å…ƒæ±‡ç‡å§‹ç»ˆä¸º1ä¸”ä¸å¯ä¿®æ”¹
                        exchangeRateInput.value = '1.0000';
                        exchangeRateInput.disabled = true;
                    } else {
                        // å¯¹äºå…¶ä»–è´§å¸ï¼Œå¯ç”¨ç¼–è¾‘
                        exchangeRateInput.disabled = false;
                        
                        // åªæœ‰åœ¨ä¸ä¿ç•™ç°æœ‰æ±‡ç‡æ—¶æ‰è®¾ç½®é»˜è®¤å€¼
                        if (!preserveExistingRate) {
                            if (selectedCurrencyData) {
                                // è®¾ç½®ç³»ç»Ÿé»˜è®¤æ±‡ç‡ï¼Œä½†å…è®¸ç”¨æˆ·ä¿®æ”¹
                                exchangeRateInput.value = parseFloat(selectedCurrencyData.exchange_rate).toFixed(4);
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”è´§å¸ï¼Œæ¸…ç©ºæ±‡ç‡è®©ç”¨æˆ·å¡«å…¥
                                exchangeRateInput.value = '';
                            }
                        }
                    }
                } catch (error) {
                    console.error('è·å–è´§å¸æ±‡ç‡å¤±è´¥:', error);
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè®¾ç½®åˆç†çš„é»˜è®¤å€¼
                    if (selectedCurrency === 'USD') {
                        exchangeRateInput.value = '1.0000';
                        exchangeRateInput.disabled = true;
                    } else if (!preserveExistingRate) {
                        exchangeRateInput.value = '';
                        utils.showMessage('è·å–æ±‡ç‡å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥', 'warning');
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©è´§å¸ï¼Œæ¸…ç©ºæ±‡ç‡
                if (!preserveExistingRate) {
                    exchangeRateInput.value = '';
                }
            }
            
            calculateUsdAmount();
        }

        function calculateUsdAmount() {
            const amountInput = document.getElementById('expenseAmount');
            const exchangeRateInput = document.getElementById('exchangeRate');
            const usdAmountDisplay = document.getElementById('usdAmount');
            const currencySelect = document.getElementById('expenseCurrency');
            
            const amount = parseFloat(amountInput.value) || 0;
            const exchangeRate = parseFloat(exchangeRateInput.value) || 0;
            const currency = currencySelect.value;
            
            if (amount > 0 && exchangeRate > 0) {
                let usdAmount = 0;
                if (currency === 'USD') {
                    usdAmount = amount;
                } else {
                    // æ–°çš„æ±‡ç‡è®¡ç®—é€»è¾‘ï¼šå¤šå°‘å•ä½è´§å¸å…‘æ¢1ç¾å…ƒ
                    usdAmount = amount / exchangeRate;
                }
                
                // æ˜¾ç¤ºåŸå¸ç§é‡‘é¢
                const currencySymbol = currencySymbols[currency] || currency;
                const originalAmount = `${currencySymbol} ${amount.toFixed(2)}`;
                
                if (currency === 'USD') {
                    usdAmountDisplay.innerHTML = `
                        <span style="font-size: 18px; font-weight: 700;">$ ${usdAmount.toFixed(2)}</span>
                    `;
                } else {
                    usdAmountDisplay.innerHTML = `
                        <span style="color: var(--muted-foreground); font-size: 14px;">${originalAmount} Ã— ${exchangeRate} =</span><br>
                        <span style="font-size: 18px; font-weight: 700;">$ ${usdAmount.toFixed(2)}</span>
                    `;
                }
            } else {
                usdAmountDisplay.textContent = '$ 0.00';
            }
        }

        // æ˜¾ç¤ºæ–°å»ºç”³è¯·æ¨¡æ€æ¡†
        function showNewExpenseModal() {
            const modal = document.getElementById('newExpenseModal');
            modal.classList.add('show');
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        // å…³é—­æ–°å»ºç”³è¯·æ¨¡æ€æ¡†
        function closeNewExpenseModal() {
            const modal = document.getElementById('newExpenseModal');
            modal.classList.remove('show');
            document.getElementById('newExpenseForm').reset();
            selectedFiles = [];
            updateFileList();
            
            // é‡ç½®ç¼–è¾‘çŠ¶æ€
            currentEditingId = null;
            document.querySelector('#newExpenseModal .modal-title').textContent = 'æ–°å»ºæŠ¥é”€ç”³è¯·';
            document.getElementById('submitBtn').textContent = 'æäº¤ç”³è¯·';
            
            // æ¸…é™¤ URL å‚æ•°
            const url = new URL(window.location);
            url.searchParams.delete('edit');
            window.history.replaceState({}, '', url);
            
            // é‡ç½®è´§å¸è®¾ç½®åˆ°é»˜è®¤å€¼
            document.getElementById('expenseCurrency').value = 'CNY';
            document.getElementById('currencySymbol').textContent = 'CNY';
            document.getElementById('usdAmount').textContent = '$ 0.00';
            
            // é‡æ–°è°ƒç”¨handleCurrencyChangeæ¥è®¾ç½®æ­£ç¡®çš„æ±‡ç‡
            handleCurrencyChange();
            
            // ç§»é™¤ç¼–è¾‘æç¤º
            const notice = document.querySelector('#newExpenseModal .edit-notice');
            if (notice) {
                notice.remove();
            }
        }

        // å¤„ç†è¡¨å•æäº¤ï¼ˆä¿ç•™HTML5éªŒè¯ï¼‰
        async function handleFormSubmit(event) {
            console.log('ğŸ”¥ handleFormSubmit called - form submitted!');
            
            // æ‰‹åŠ¨æ£€æŸ¥è¡¨å•éªŒè¯çŠ¶æ€
            const form = document.getElementById('newExpenseForm');
            const isValid = form.checkValidity();
            console.log('ğŸ“‹ Form validation status:', isValid);
            
            if (!isValid) {
                console.log('âŒ Form validation failed');
                form.reportValidity(); // æ˜¾ç¤ºéªŒè¯é”™è¯¯
                return false;
            }
            
            event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤
            
            // æ£€æŸ¥è´¹ç”¨è¯´æ˜å­—æ®µ
            const description = document.getElementById('expenseDescription').value;
            console.log('ğŸ“ Description value:', description);
            
            return await submitExpense();
        }

        // æäº¤æŠ¥é”€ç”³è¯·
        async function submitExpense() {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading-spinner"></div> æäº¤ä¸­...';
                
                // éªŒè¯æ–‡ä»¶ä¸Šä¼ 
                if (selectedFiles.length === 0) {
                    utils.showMessage('è¯·ä¸Šä¼ æŠ¥é”€å‡­è¯', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // åˆ›å»º FormData å¯¹è±¡
                const formData = new FormData();
                formData.append('title', document.getElementById('expenseTitle').value);
                formData.append('category', document.getElementById('expenseCategory').value);
                formData.append('amount', document.getElementById('expenseAmount').value);
                formData.append('currency', document.getElementById('expenseCurrency').value);
                formData.append('exchange_rate', document.getElementById('exchangeRate').value);
                formData.append('expense_date', document.getElementById('expenseDate').value);
                formData.append('description', document.getElementById('expenseDescription').value);
                
                // æ·»åŠ æ–‡ä»¶
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                // è¡¨å•éªŒè¯
                const title = formData.get('title');
                const category = formData.get('category');
                const amount = formData.get('amount');
                const currency = formData.get('currency');
                const exchangeRate = formData.get('exchange_rate');
                const expense_date = formData.get('expense_date');
                const description = formData.get('description');
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('éªŒè¯å­—æ®µ:', {
                    title: title,
                    category: category,
                    amount: amount,
                    currency: currency,
                    exchangeRate: exchangeRate,
                    expense_date: expense_date,
                    description: description
                });
                
                // HTML5å·²ç»éªŒè¯äº†requiredå­—æ®µï¼Œè¿™é‡Œåªéœ€è¦éªŒè¯è‡ªå®šä¹‰è§„åˆ™
                // éªŒè¯å¤‡æ³¨é•¿åº¦
                if (description && description.trim().length < 5) {
                    utils.showMessage('è´¹ç”¨è¯´æ˜è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // éªŒè¯æ±‡ç‡
                if (parseFloat(exchangeRate) <= 0) {
                    utils.showMessage('æ±‡ç‡å¿…é¡»å¤§äº0', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                // æ ¹æ®æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
                let url, method;
                if (currentEditingId) {
                    url = `/api/expenses/${currentEditingId}`;
                    method = 'PUT';
                    submitBtn.innerHTML = '<div class="loading-spinner"></div> ä¿å­˜ä¸­...';
                } else {
                    url = '/api/expenses';
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (currentEditingId) {
                        utils.showMessage(result.message || 'æŠ¥é”€ç”³è¯·å·²æ›´æ–°ï¼', 'success');
                    } else {
                        utils.showMessage(`æŠ¥é”€ç”³è¯·æäº¤æˆåŠŸï¼å·²ä¸Šä¼  ${result.files_count} ä¸ªæ–‡ä»¶`, 'success');
                    }
                    closeNewExpenseModal();
                    loadExpenses();
                    updateStats();
                } else {
                    utils.showMessage(result.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                utils.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // åˆå§‹åŒ–é«˜çº§ç­›é€‰
        function initAdvancedFilters() {
            advancedFilters = new AdvancedFilters('advancedFilters', {
                title: 'æŠ¥é”€ç”³è¯·ç­›é€‰',
                collapsed: false,
                showQuickFilters: true,
                showSearch: true,
                showSavedFilters: true,
                fields: [
                    {
                        key: 'status',
                        label: 'å®¡æ‰¹çŠ¶æ€',
                        type: 'select',
                        options: [
                            { value: 'pending', label: 'å¾…å®¡æ‰¹' },
                            { value: 'approved', label: 'å·²é€šè¿‡' },
                            { value: 'rejected', label: 'å·²æ‹’ç»' }
                        ]
                    },
                    {
                        key: 'category',
                        label: 'è´¹ç”¨ç±»å‹',
                        type: 'select',
                        options: [] // å°†é€šè¿‡ loadCategories å¡«å……
                    },
                    {
                        key: 'currency',
                        label: 'è´§å¸ç±»å‹',
                        type: 'select',
                        options: [] // å°†é€šè¿‡ loadCurrencies å¡«å……
                    },
                    {
                        key: 'amount',
                        label: 'é‡‘é¢èŒƒå›´',
                        type: 'amountRange'
                    },
                    {
                        key: 'expense_date',
                        label: 'è´¹ç”¨æ—¥æœŸ',
                        type: 'dateRange'
                    },
                    {
                        key: 'created_at',
                        label: 'ç”³è¯·æ—¥æœŸ',
                        type: 'dateRange'
                    }
                ],
                quickFilters: [
                    {
                        key: 'today',
                        label: 'ä»Šæ—¥ç”³è¯·',
                        filters: {
                            created_at_start: new Date().toISOString().split('T')[0],
                            created_at_end: new Date().toISOString().split('T')[0]
                        }
                    },
                    {
                        key: 'week',
                        label: 'æœ¬å‘¨ç”³è¯·',
                        filters: {
                            created_at_start: getWeekStart().toISOString().split('T')[0],
                            created_at_end: new Date().toISOString().split('T')[0]
                        }
                    },
                    {
                        key: 'month',
                        label: 'æœ¬æœˆç”³è¯·',
                        filters: {
                            created_at_start: getMonthStart().toISOString().split('T')[0],
                            created_at_end: new Date().toISOString().split('T')[0]
                        }
                    },
                    {
                        key: 'pending',
                        label: 'å¾…å®¡æ‰¹',
                        filters: { status: 'pending' }
                    },
                    {
                        key: 'high_amount',
                        label: 'é«˜é‡‘é¢ (>1000å…ƒ)',
                        filters: { amount_min: '1000' }
                    }
                ],
                onFilterChange: (filters) => {
                    console.log('ç­›é€‰æ¡ä»¶å˜åŒ–:', filters);
                    applyAdvancedFilters(filters);
                },
                onSearch: (query) => {
                    console.log('æœç´¢:', query);
                }
            });
            
            // åŠ è½½åˆ†ç±»å’Œè´§å¸é€‰é¡¹
            loadFilterOptions();
        }
        
        // åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadFilterOptions() {
            try {
                // ä¿å­˜å½“å‰çš„ç­›é€‰æ¡ä»¶
                const currentFilters = advancedFilters ? advancedFilters.getFilters() : {};
                
                // åŠ è½½åˆ†ç±»
                const categories = await api.get('/api/admin/categories');
                const categoryField = advancedFilters.config.fields.find(f => f.key === 'category');
                if (categoryField) {
                    categoryField.options = categories.map(cat => ({
                        value: cat.name,
                        label: cat.name
                    }));
                }
                
                // åŠ è½½è´§å¸
                const currencies = await api.get('/api/admin/currencies');
                const currencyField = advancedFilters.config.fields.find(f => f.key === 'currency');
                if (currencyField) {
                    currencyField.options = currencies.map(currency => ({
                        value: currency.code,
                        label: `${currency.name} (${currency.symbol})`
                    }));
                }
                
                // é‡æ–°æ¸²æŸ“ç­›é€‰å™¨
                advancedFilters.render();
                advancedFilters.bindEvents();
                
                // å…ˆæ¢å¤å·²æœ‰ç­›é€‰ï¼ˆå¦‚ç”¨æˆ·æ“ä½œååˆ·æ–°ï¼‰
                if (Object.keys(currentFilters).length > 0) {
                    advancedFilters.setFilters(currentFilters);
                } else {
                    // é¦–æ¬¡åŠ è½½ï¼šä»URLå‚æ•°åˆå§‹åŒ–ç­›é€‰ï¼Œç¡®ä¿é€‰é¡¹åŠ è½½å®Œæˆåå†åº”ç”¨
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlFilters = {};
                    urlParams.forEach((value, key) => {
                        if (value) urlFilters[key] = value;
                    });
                    if (Object.keys(urlFilters).length > 0) {
                        advancedFilters.setFilters(urlFilters);
                    }
                }
                
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // åº”ç”¨é«˜çº§ç­›é€‰
        function applyAdvancedFilters(filters) {
            console.log('å¼€å§‹åº”ç”¨ç­›é€‰:', filters);
            
            filteredExpenses = expenses.filter(expense => {
                // çŠ¶æ€ç­›é€‰
                if (filters.status && expense.status !== filters.status) {
                    return false;
                }
                
                // åˆ†ç±»ç­›é€‰
                if (filters.category && expense.category !== filters.category) {
                    return false;
                }
                
                // è´§å¸ç­›é€‰
                if (filters.currency && expense.currency !== filters.currency) {
                    return false;
                }
                
                // é‡‘é¢èŒƒå›´ç­›é€‰
                if (filters.amount_min && parseFloat(expense.amount) < parseFloat(filters.amount_min)) {
                    return false;
                }
                if (filters.amount_max && parseFloat(expense.amount) > parseFloat(filters.amount_max)) {
                    return false;
                }
                
                // è´¹ç”¨æ—¥æœŸç­›é€‰
                if (filters.expense_date_start && expense.expense_date < filters.expense_date_start) {
                    return false;
                }
                if (filters.expense_date_end && expense.expense_date > filters.expense_date_end) {
                    return false;
                }
                
                // ç”³è¯·æ—¥æœŸç­›é€‰
                if (filters.created_at_start) {
                    const expenseDate = new Date(expense.created_at).toISOString().split('T')[0];
                    if (expenseDate < filters.created_at_start) {
                        return false;
                    }
                }
                if (filters.created_at_end) {
                    const expenseDate = new Date(expense.created_at).toISOString().split('T')[0];
                    if (expenseDate > filters.created_at_end) {
                        return false;
                    }
                }
                
                // æœç´¢ç­›é€‰
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    const searchableText = [
                        expense.title,
                        expense.description || '',
                        expense.submitter || '',
                        expense.category
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('ç­›é€‰åçš„æ•°æ®:', filteredExpenses);
            renderExpenses(filteredExpenses);
            updateResultsCount(filteredExpenses.length);
        }
        
        // æ›´æ–°ç»“æœæ•°é‡
        function updateResultsCount(count) {
            const resultsCountEl = document.getElementById('resultsCount');
            if (resultsCountEl) {
                resultsCountEl.textContent = count;
            }
        }
        
        // è·å–æœ¬å‘¨å¼€å§‹æ—¥æœŸ
        function getWeekStart() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // å‘¨ä¸€ä¸ºä¸€å‘¨çš„å¼€å§‹
            return new Date(today.setDate(diff));
        }
        
        // è·å–æœ¬æœˆå¼€å§‹æ—¥æœŸ
        function getMonthStart() {
            const today = new Date();
            return new Date(today.getFullYear(), today.getMonth(), 1);
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(status) {
            currentStatus = status;
            
            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            loadExpenses();
        }

        // åŠ è½½æŠ¥é”€æ•°æ® - æ”¯æŒåˆ†é¡µ
        async function loadExpenses(paginationParams = null) {
            const list = document.getElementById('expensesList');
            const emptyState = document.getElementById('emptyExpenses');
            
            list.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><span>åŠ è½½ä¸­...</span></div>';
            emptyState.classList.add('hidden');
            
            try {
                let url = '/api/expenses?status=all';
                
                // æ·»åŠ åˆ†é¡µå‚æ•°
                if (paginationParams) {
                    url += `&page=${paginationParams.page}&per_page=${paginationParams.perPage}`;
                }
                
                const response = await api.get(url);
                
                // åˆ¤æ–­å“åº”æ ¼å¼ï¼šæ–°çš„åˆ†é¡µæ ¼å¼ vs æ—§çš„æ•°ç»„æ ¼å¼
                if (response.data && response.pagination) {
                    // æ–°çš„åˆ†é¡µæ ¼å¼
                    expenses = response.data;
                    
                    // æ›´æ–°åˆ†é¡µUI
                    if (!expensesPagination) {
                        // åˆå§‹åŒ–åˆ†é¡µç®¡ç†å™¨
                        expensesPagination = new PaginationManager('expensesPagination', {
                            perPage: 20,
                            onPageChange: (params) => {
                                console.log('ğŸ“„ é¡µé¢å˜æ›´:', params);
                                loadExpenses(params);
                            }
                        });
                    }
                    expensesPagination.update(response.pagination);
                } else {
                    // å‘åå…¼å®¹æ—§æ ¼å¼
                    expenses = response;
                    // éšè—åˆ†é¡µUI
                    if (expensesPagination) {
                        expensesPagination.reset();
                    }
                }
                
                // å¦‚æœå­˜åœ¨ç­›é€‰æ¡ä»¶ï¼Œä¼˜å…ˆåº”ç”¨ç­›é€‰ï¼ˆæ³¨æ„ï¼šåˆ†é¡µæ¨¡å¼ä¸‹ç­›é€‰åœ¨æœåŠ¡ç«¯è¿›è¡Œï¼‰
                if (advancedFilters && Object.keys(advancedFilters.getFilters()).length > 0 && !paginationParams) {
                    applyAdvancedFilters(advancedFilters.getFilters());
                    updateStats();
                    return;
                }
                
                // æ˜¾ç¤ºæ•°æ®
                filteredExpenses = expenses;
                
                if (expenses.length === 0) {
                    list.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    // éšè—åˆ†é¡µ
                    if (expensesPagination) {
                        expensesPagination.reset();
                    }
                } else {
                    renderExpenses(filteredExpenses);
                    emptyState.classList.add('hidden');
                }
                
                updateStats();
                updateResultsCount(filteredExpenses.length);
            } catch (error) {
                console.error('åŠ è½½æŠ¥é”€æ•°æ®å¤±è´¥:', error);
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>åŠ è½½å¤±è´¥</h3><p>æ— æ³•åŠ è½½æŠ¥é”€æ•°æ®ï¼Œè¯·ç¨åé‡è¯•</p><button class="btn btn-primary btn-sm" onclick="loadExpenses()">é‡è¯•</button></div>';
            }
        }

        // æ¸²æŸ“æŠ¥é”€åˆ—è¡¨
        function renderExpenses(data) {
            const list = document.getElementById('expensesList');
            
            const html = data.map(expense => `
                <div class="list-item animate-fadeIn">
                    <div class="item-checkbox">
                        <input type="checkbox" value="${expense.id}" class="expense-select">
                    </div>
                    <div class="item-info">
                        <h4 class="item-title">${expense.title}</h4>
                        <div class="item-meta">
                            <span>ç±»å‹ï¼š${expense.category}</span>
                            <span>ç”³è¯·äººï¼š${expense.submitter}</span>
                            <span>æ—¶é—´ï¼š${utils.formatDate(expense.created_at)}</span>
                            <span class="files-info">ğŸ“ ${expense.files ? expense.files.length : 0} ä¸ªé™„ä»¶</span>
                        </div>
                        <p class="item-description">${expense.description || 'æ— è¯¦ç»†è¯´æ˜'}</p>
                    </div>
                    <div class="item-amount">
                        <div class="amount-display">
                            <span class="amount">${utils.formatMultiCurrencyAmount(expense.amount, expense.currency, expense.usd_amount)}</span>
                            ${expense.currency !== 'CNY' ? `<span class="exchange-info">æ±‡ç‡: ${expense.exchange_rate}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-status">
                        <span class="badge ${utils.getStatusClass(expense.status)}">${utils.getStatusText(expense.status)}</span>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewExpense(${expense.id})">æŸ¥çœ‹</button>
                        ${expense.status === 'pending' || expense.status === 'rejected' ? 
                            `<button class="btn btn-primary btn-sm" onclick="editExpense(${expense.id})">ç¼–è¾‘</button>` : ''}
                        ${expense.status === 'pending' ? 
                             `<button class="btn btn-destructive btn-sm" onclick="deleteExpense(${expense.id})">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            list.innerHTML = html;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            api.get('/api/stats').then(stats => {
                document.getElementById('totalExpenses').textContent = stats.total;
                document.getElementById('pendingExpenses').textContent = stats.pending;
                document.getElementById('approvedExpenses').textContent = stats.approved;
                
                // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
                document.getElementById('allCount').textContent = stats.total;
                document.getElementById('pendingCount').textContent = stats.pending;
                document.getElementById('approvedCount').textContent = stats.approved;
                document.getElementById('rejectedCount').textContent = stats.rejected;
            });
        }

        // æŸ¥çœ‹æŠ¥é”€è¯¦æƒ…
        function viewExpense(id) {
            window.location.href = `/expense/${id}`;
        }

        // åˆ é™¤æŠ¥é”€ç”³è¯·
        async function deleteExpense(id) {
            if (!await utils.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥é”€ç”³è¯·å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/expenses/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    utils.showMessage('æŠ¥é”€ç”³è¯·å·²åˆ é™¤', 'success');
                    loadExpenses(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    updateStats(); // æ›´æ–°ç»Ÿè®¡
                } else {
                    utils.showMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                utils.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // ç¼–è¾‘æŠ¥é”€ç”³è¯·
        
        async function editExpense(id) {
            try {
                // è·å–ç°æœ‰çš„æŠ¥é”€æ•°æ®
                const response = await fetch(`/api/expenses?status=all`);
                const expenses = await response.json();
                const expense = expenses.find(e => e.id === id);
                
                if (!expense) {
                    utils.showMessage('æœªæ‰¾åˆ°æŠ¥é”€ç”³è¯·', 'error');
                    return;
                }
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('expenseTitle').value = expense.title;
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseDate').value = expense.expense_date;
                document.getElementById('expenseDescription').value = expense.description || '';
                
                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨ï¼ˆéœ€è¦é‡æ–°ä¸Šä¼ ï¼‰
                selectedFiles = [];
                updateFileList();
                
                // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                currentEditingId = id;
                document.querySelector('#newExpenseModal .modal-title').textContent = 'ç¼–è¾‘æŠ¥é”€ç”³è¯·';
                document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                showNewExpenseModal();
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                const modalBody = document.querySelector('#newExpenseModal .modal-body');
                const existingNotice = modalBody.querySelector('.edit-notice');
                if (!existingNotice) {
                    const notice = document.createElement('div');
                    notice.className = 'alert alert-info edit-notice';
                    notice.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #e0f2fe; border: 1px solid #b3e5fc; border-radius: 6px; margin-bottom: 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0288d1" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                            <span style="color: #0277bd; font-size: 14px;">ç¼–è¾‘åå°†é‡æ–°å‘èµ·ç”³è¯·ï¼ŒçŠ¶æ€é‡ç½®ä¸ºâ€œå¾…å®¡æ‰¹â€ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ æŠ¥é”€å‡­è¯ã€‚</span>
                        </div>
                    `;
                    modalBody.insertBefore(notice, modalBody.firstChild);
                }
                
            } catch (error) {
                console.error('åŠ è½½æŠ¥é”€æ•°æ®å¤±è´¥:', error);
                utils.showMessage('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // å…¨é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.expense-select');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        // åŠ è½½æŠ¥é”€æ•°æ®ç”¨äºç¼–è¾‘
        async function loadExpenseForEdit(expenseId) {
            try {
                // è·å–ç°æœ‰çš„æŠ¥é”€æ•°æ®
                const response = await fetch(`/api/expenses?status=all`);
                if (!response.ok) {
                    throw new Error('Failed to load expenses');
                }
                
                const expenses = await response.json();
                const expense = expenses.find(e => e.id === expenseId);
                
                if (!expense) {
                    utils.showMessage('æœªæ‰¾åˆ°æŠ¥é”€ç”³è¯·', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¼–è¾‘ï¼ˆåªèƒ½ç¼–è¾‘å¾…å®¡æ‰¹æˆ–å·²æ‹’ç»çš„ç”³è¯·ï¼‰
                if (expense.status !== 'pending' && expense.status !== 'rejected') {
                    utils.showMessage('åªèƒ½ç¼–è¾‘å¾…å®¡æ‰¹æˆ–å·²æ‹’ç»çš„ç”³è¯·', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç”³è¯·äººæœ¬äººï¼ˆåç«¯ä¼šå†æ¬¡éªŒè¯ï¼‰
                
                // é¢„å¡«å……è¡¨å•æ•°æ®
                document.getElementById('expenseTitle').value = expense.title;
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseCurrency').value = expense.currency;
                document.getElementById('exchangeRate').value = expense.exchange_rate;
                document.getElementById('expenseDate').value = expense.expense_date;
                document.getElementById('expenseDescription').value = expense.description || '';
                
                // å¤„ç†è´§å¸ç›¸å…³çš„è®¾ç½®ï¼ˆä¿ç•™ç°æœ‰æ±‡ç‡ï¼‰
                handleCurrencyChange(true);
                calculateUsdAmount();
                
                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨ï¼ˆéœ€è¦é‡æ–°ä¸Šä¼ ï¼‰
                selectedFiles = [];
                updateFileList();
                
                // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                currentEditingId = expenseId;
                document.querySelector('#newExpenseModal .modal-title').textContent = 'ç¼–è¾‘æŠ¥é”€ç”³è¯·';
                document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                showNewExpenseModal();
                
                // æ˜¾ç¤ºç¼–è¾‘æç¤ºä¿¡æ¯
                const modalBody = document.querySelector('#newExpenseModal .modal-body');
                const existingNotice = modalBody.querySelector('.edit-notice');
                if (!existingNotice) {
                    const notice = document.createElement('div');
                    notice.className = 'alert alert-info edit-notice';
                    notice.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #e0f2fe; border: 1px solid #b3e5fc; border-radius: 6px; margin-bottom: 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0288d1" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                            <span style="color: #0277bd; font-size: 14px;">ç¼–è¾‘åå°†é‡æ–°å‘èµ·ç”³è¯·ï¼ŒçŠ¶æ€é‡ç½®ä¸ºâ€œå¾…å®¡æ‰¹â€ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ æŠ¥é”€å‡­è¯ã€‚</span>
                        </div>
                    `;
                    modalBody.insertBefore(notice, modalBody.firstChild);
                }
                
            } catch (error) {
                console.error('åŠ è½½æŠ¥é”€æ•°æ®å¤±è´¥:', error);
                utils.showMessage('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é«˜çº§ç­›é€‰
            initAdvancedFilters();
            
            // æ£€æŸ¥ URL å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const currencyParam = urlParams.get('currency');
            const categoryParam = urlParams.get('category');
            const editParam = urlParams.get('edit');
            
            // ç§»é™¤å»¶è¿Ÿåˆå§‹åŒ–ï¼ŒURLå‚æ•°å°†åœ¨loadFilterOptionså®Œæˆåç»Ÿä¸€åº”ç”¨
            
            // å¦‚æœæœ‰ç¼–è¾‘å‚æ•°ï¼Œåˆ™è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (editParam) {
                loadExpenseForEdit(parseInt(editParam));
            }
            
            loadFormOptions(); // åŠ è½½è¡¨å•é€‰é¡¹
            initFileUpload();
            loadExpenses();
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    const dropdown = document.getElementById('userDropdown');
                    dropdown.classList.remove('show');
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('newExpenseModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeNewExpenseModal();
                }
            });
        });
    </script>
</body>
</html>