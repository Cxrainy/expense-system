# 报表导出功能使用指南

## 新功能概述

新增了高级报表导出功能，支持：
1. 按报销类型分工作簿导出
2. 图片附件嵌入Excel（支持不同比例标准）
3. 时间区间筛选
4. 仅管理员权限可访问
5. 与现有页面布局保持一致

## 功能特点

### 📊 **分工作簿导出**
- 每个报销类型（餐饮费、交通费、办公费等）创建独立工作簿
- 可选择是否按类型分组

### 🖼️ **图片处理**
- **横向图片**：最大宽度600px，按比例缩放
- **纵向图片**：最大高度400px，按比例缩放
- **质量选项**：高质量/中等质量/低质量
- **自动适配**：Excel行高自动调整以容纳图片

### 📅 **时间筛选**
- 开始日期和结束日期选择
- 审批状态筛选（全部/待审批/已通过/已拒绝）

### 📋 **导出内容**
- 报销日期
- 报销类型
- 报销标题
- 报销金额（USD统一）
- 报销备注
- 审批意见（可选）
- 申请人信息
- 图片附件（嵌入Excel）
- 其他文件位置标注

## 安装新依赖

需要安装图片处理相关依赖：

```bash
pip install Pillow==10.1.0 xlsxwriter==3.1.9
```

或者重新安装所有依赖：

```bash
pip install -r requirements.txt
```

## 使用步骤

### 1. 管理员登录
使用管理员账户登录系统：
- 邮箱：`admin@company.com`
- 密码：`admin123`

### 2. 访问报表页面
在侧边栏导航中点击 "报表导出" 或直接访问：
```
http://localhost:5000/reports
```

### 3. 设置筛选条件
- **时间范围**：选择开始和结束日期
- **审批状态**：选择要导出的状态
- **图片质量**：选择图片处理质量
- **导出选项**：勾选所需功能

### 4. 预览数据
点击 "预览数据" 按钮查看：
- 总记录数
- 报销类型数量
- 总金额统计
- 包含图片的记录数
- 按类型分布详情

### 5. 导出报表
点击 "导出Excel报表" 开始导出：
- 显示进度条
- 自动下载Excel文件
- 文件名包含时间范围

## 文件结构

### 新增文件
```
expense-system/
├── templates/
│   └── reports.html          # 报表导出页面
└── REPORT_FEATURE_README.md  # 本说明文件
```

### 修改的文件
```
expense-system/
├── app.py                    # 新增报表相关API和路由
├── requirements.txt          # 添加Pillow和xlsxwriter依赖
└── templates/               # 所有管理员页面添加报表导航
    ├── dashboard.html
    ├── expenses.html
    ├── approvals.html
    ├── admin.html
    ├── export.html
    ├── expense_detail.html
    └── approval_detail.html
```

## API接口

### 预览接口
```
POST /api/reports/preview
Content-Type: application/json

{
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "status": "all"
}
```

### 导出接口
```
POST /api/reports/export
Content-Type: multipart/form-data

- start_date: 开始日期
- end_date: 结束日期
- status: 状态筛选
- include_images: 是否包含图片
- group_by_category: 是否按类型分组
- include_comments: 是否包含审批意见
- image_quality: 图片质量
```

## 图片处理技术细节

### 图片质量选项
- **高质量**：最大600x400px，JPEG质量85%
- **中等质量**：最大400x300px，JPEG质量85%
- **低质量**：最大200x150px，JPEG质量60%

### 比例标准
- **横向图片**（宽>高）：按最大宽度限制，等比例缩放
- **纵向图片**（高>宽）：按最大高度限制，等比例缩放
- **正方形图片**：按较小边限制

### Excel适配
- 自动转换像素为Excel单位
- 动态调整行高容纳图片
- 每行最多3张图片避免过度拥挤

## 权限控制

✅ **仅管理员权限**：
- 页面访问需要admin角色
- API调用验证管理员权限
- 非管理员自动重定向到仪表板

## 测试建议

1. **权限测试**：用员工账户尝试访问报表页面
2. **数据测试**：确保有包含图片的报销记录
3. **时间筛选测试**：测试不同时间范围
4. **图片测试**：上传不同格式和尺寸的图片
5. **导出测试**：测试各种导出选项组合

## 故障排除

### 常见问题

1. **图片无法显示**
   - 检查uploads目录权限
   - 确认图片文件存在
   - 验证图片格式支持

2. **导出失败**
   - 检查Pillow和xlsxwriter安装
   - 确认临时文件写入权限
   - 查看后端错误日志

3. **页面无法访问**
   - 确认使用管理员账户登录
   - 检查路由是否正确配置

### 调试信息

后端会输出详细的调试信息：
- 图片处理状态
- 文件访问日志
- 错误堆栈信息

## 性能考虑

- 大量图片导出可能需要较长时间
- 建议单次导出不超过100条包含图片的记录
- 图片质量设置影响文件大小和处理时间

## 扩展建议

1. **增加更多图片格式支持**
2. **支持视频文件缩略图**
3. **添加导出进度实时更新**
4. **支持PDF格式导出**
5. **添加邮件发送功能**
