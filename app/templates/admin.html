<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user-management.css') }}">
</head>
<body class="dashboard-page">
    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">æŠ¥é”€ç®¡ç†ç³»ç»Ÿ</h2>
        </div>
        <div class="sidebar-nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                        <span class="nav-text">ä»ªè¡¨æ¿</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/expenses" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <span class="nav-text">æŠ¥é”€ç”³è¯·</span>
                    </a>
                </li>
                {% if session.role == 'admin' %}
                <li class="nav-item">
                    <a href="/approvals" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22,4 12,14.01 9,11.01"/>
                        </svg>
                        <span class="nav-text">å®¡æ‰¹ç®¡ç†</span>
                    </a>
                </li>
                <!-- æ–°å¢ï¼šæ•°æ®å¯¼å‡ºå…¥å£ -->
                <!-- <li class="nav-item">
                    <a href="/export" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v8"/>
                            <path d="M8 9l4 4 4-4"/>
                            <rect x="4" y="17" width="16" height="3" rx="1"/>
                        </svg>
                        <span class="nav-text">æ•°æ®å¯¼å‡º</span>
                    </a>
                </li> -->
                <li class="nav-item">
                    <a href="/reports" class="nav-link">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 9h6v6H9z"/>
                            <path d="M9 1v2"/>
                            <path d="M15 1v2"/>
                            <path d="M9 21v2"/>
                            <path d="M15 21v2"/>
                            <path d="M1 9h2"/>
                            <path d="M1 15h2"/>
                            <path d="M21 9h2"/>
                            <path d="M21 15h2"/>
                        </svg>
                        <span class="nav-text">æŠ¥è¡¨å¯¼å‡º</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin" class="nav-link active">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span class="nav-text">ç³»ç»Ÿç®¡ç†</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="topbar-right">
                <!-- é€šçŸ¥ -->
                <div class="notification-wrapper">
                    <button class="notification-btn" onclick="toggleNotifications()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4 class="notification-title">é€šçŸ¥æ¶ˆæ¯</h4>
                            <a href="#" class="mark-all-read" onclick="markAllAsRead()">å…¨éƒ¨å·²è¯»</a>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">
                                <div class="notification-empty-icon">ğŸ“­</div>
                                <p>æš‚æ— æ–°é€šçŸ¥</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·èœå• -->
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        {{ session.username[0] if session.username else 'U' }}
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <div class="user-name">{{ session.username }}</div>
                            <div class="user-email">{{ session.role }}</div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="/logout" class="dropdown-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16,17 21,12 16,7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <main class="page-content">
            <div class="content-header">
                <div class="header-left">
                    <h1>ç³»ç»Ÿç®¡ç†</h1>
                    <p class="page-subtitle">ç®¡ç†ç³»ç»Ÿçš„è´§å¸å’Œåˆ†ç±»é…ç½®</p>
                </div>
            </div>

            <!-- ç®¡ç†é¢æ¿ -->
            <div class="enhanced-stats">
                <!-- è´§å¸ç®¡ç† -->
                <div class="stat-panel-ex">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <svg class="panel-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="2" r="3"/>
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            è´§å¸ç®¡ç†
                        </h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddCurrencyModal()">æ·»åŠ è´§å¸</button>
                    </div>
                    
                    <!-- è´§å¸ç­›é€‰ -->
                    <div id="currencyFilters"></div>
                    
                    <div class="panel-content">
                        <div id="currenciesList" class="admin-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†ç±»ç®¡ç† -->
                <div class="stat-panel-ex">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <svg class="panel-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            åˆ†ç±»ç®¡ç†
                        </h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddCategoryModal()">æ·»åŠ åˆ†ç±»</button>
                    </div>
                    
                    <!-- åˆ†ç±»ç­›é€‰ -->
                    <div id="categoryFilters"></div>
                    
                    <div class="panel-content">
                        <div id="categoriesList" class="admin-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div class="stat-panel-ex">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <svg class="panel-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            ç”¨æˆ·ç®¡ç†
                        </h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">æ·»åŠ ç”¨æˆ·</button>
                    </div>
                    
                    <!-- ç”¨æˆ·æœç´¢ -->
                    <div class="search-filters">
                        <div class="search-box">
                            <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." oninput="filterUsers()">
                            <button type="button" class="search-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                            </button>
                        </div>
                        <select id="roleFilter" onchange="filterUsers()">
                            <option value="">æ‰€æœ‰è§’è‰²</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                        </select>
                    </div>
                    
                    <div class="panel-content">
                        <div id="usersList" class="admin-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®åº“ç®¡ç† -->
                <div class="stat-panel-ex database-management">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <svg class="panel-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                            </svg>
                            æ•°æ®åº“ç®¡ç†
                        </h3>
                        <button class="btn btn-secondary btn-sm" onclick="refreshDatabaseStats()">åˆ·æ–°ç»Ÿè®¡</button>
                    </div>
                    
                    <div class="panel-content">
                        <!-- æ•°æ®åº“ç»Ÿè®¡ -->
                        <div class="database-stats" id="databaseStats">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ç»Ÿè®¡ä¸­...</span>
                            </div>
                        </div>
                        
                        <!-- æ•°æ®ç®¡ç†æ“ä½œ -->
                        <div class="data-management-zone">
                            <h4 class="section-title">ğŸ“Š æ•°æ®ç®¡ç†</h4>
                            <p class="section-subtitle">ç³»ç»Ÿæ•°æ®å¯¼å…¥å’Œç®¡ç†åŠŸèƒ½</p>
                            
                            <div class="management-actions">
                                <button class="btn btn-success" onclick="importExpenseCategories()" id="importCategoriesBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="12" y1="18" x2="12" y2="12"/>
                                        <polyline points="9,15 12,12 15,15"/>
                                    </svg>
                                    å¯¼å…¥æŠ¥é”€ç±»å‹
                                </button>
                                <span class="btn-help-text">å¯¼å…¥16ç§é¢„å®šä¹‰çš„æŠ¥é”€ç±»å‹ï¼ˆåŒ…å«è¯¦ç»†æè¿°ï¼‰</span>
                            </div>
                        </div>
                        
                        <!-- å±é™©æ“ä½œåŒºåŸŸ -->
                        <div class="danger-zone">
                            <h4 class="danger-title">âš ï¸ å±é™©æ“ä½œ</h4>
                            <p class="danger-subtitle">ä»¥ä¸‹æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                            
                            <div class="danger-actions">
                                <button class="btn btn-warning" onclick="showClearDatabaseModal()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18"/>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c0-1-1-2-1-2V6"/>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                                </button>
                                
                                <button class="btn btn-primary" onclick="showResetDatabaseModal()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 4v6h6"/>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                    </svg>
                                    é‡ç½®ä¸ºé»˜è®¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- æ·»åŠ è´§å¸æ¨¡æ€æ¡† -->
    <div class="modal" id="addCurrencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ è´§å¸</h3>
                <button class="modal-close" onclick="closeAddCurrencyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addCurrencyForm">
                    <div class="form-group">
                        <label class="form-label">è´§å¸ä»£ç </label>
                        <input type="text" id="currencyCode" class="form-input" placeholder="å¦‚: USD" required maxlength="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è´§å¸åç§°</label>
                        <input type="text" id="currencyName" class="form-input" placeholder="å¦‚: ç¾å…ƒ" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è´§å¸ç¬¦å·</label>
                        <input type="text" id="currencySymbol" class="form-input" placeholder="å¦‚: $" required maxlength="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ±‡ç‡ <small style="color: var(--muted-foreground);">ï¼ˆå¤šå°‘å•ä½è¯¥è´§å¸ = 1ç¾å…ƒï¼‰</small></label>
                        <input type="number" id="exchangeRate" class="form-input" placeholder="7.0000" step="0.0001" min="0.0001" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddCurrencyModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addCurrency()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ†ç±»æ¨¡æ€æ¡† -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ åˆ†ç±»</h3>
                <button class="modal-close" onclick="closeAddCategoryModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»åç§°</label>
                        <input type="text" id="categoryName" class="form-input" placeholder="å¦‚: é¤é¥®è´¹" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»æè¿°</label>
                        <textarea id="categoryDescription" class="form-textarea" placeholder="æè¿°è¯¥åˆ†ç±»çš„ç”¨é€”..." rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddCategoryModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addCategory()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeAddUserModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å <span style="color: var(--destructive);">*</span></label>
                        <input type="text" id="newUserUsername" class="form-input" placeholder="å¦‚: zhang_san" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‚®ç®± <span style="color: var(--destructive);">*</span></label>
                        <input type="email" id="newUserEmail" class="form-input" placeholder="å¦‚: zhangsan@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç  <span style="color: var(--destructive);">*</span></label>
                        <input type="password" id="newUserPassword" class="form-input" placeholder="è‡³å°‘6ä½å­—ç¬¦" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¡®è®¤å¯†ç  <span style="color: var(--destructive);">*</span></label>
                        <input type="password" id="newUserPasswordConfirm" class="form-input" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è§’è‰²</label>
                        <select id="newUserRole" class="form-select">
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ç”¨æˆ·</h3>
                <button class="modal-close" onclick="closeEditUserModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å <span style="color: var(--destructive);">*</span></label>
                        <input type="text" id="editUserUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‚®ç®± <span style="color: var(--destructive);">*</span></label>
                        <input type="email" id="editUserEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–°å¯†ç  <span style="color: var(--muted-foreground); font-size: 12px;">(ç•™ç©ºåˆ™ä¸ä¿®æ”¹)</span></label>
                        <input type="password" id="editUserPassword" class="form-input" placeholder="è¾“å…¥æ–°å¯†ç æˆ–ç•™ç©ºä¸ä¿®æ”¹">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="editUserPasswordConfirm" class="form-input" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è§’è‰²</label>
                        <select id="editUserRole" class="form-select">
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditUserModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="updateUser()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è´§å¸æ¨¡æ€æ¡† -->
    <div class="modal" id="editCurrencyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘è´§å¸</h3>
                <button class="modal-close" onclick="closeEditCurrencyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="editCurrencyForm">
                    <input type="hidden" id="editCurrencyId">
                    <div class="form-group">
                        <label class="form-label">è´§å¸ä»£ç </label>
                        <input type="text" id="editCurrencyCode" class="form-input" placeholder="å¦‚: USD" required maxlength="10" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è´§å¸åç§°</label>
                        <input type="text" id="editCurrencyName" class="form-input" placeholder="å¦‚: ç¾å…ƒ" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è´§å¸ç¬¦å·</label>
                        <input type="text" id="editCurrencySymbol" class="form-input" placeholder="å¦‚: $" required maxlength="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ±‡ç‡ <small style="color: var(--muted-foreground);">ï¼ˆå¤šå°‘å•ä½è¯¥è´§å¸ = 1ç¾å…ƒï¼‰</small></label>
                        <input type="number" id="editExchangeRate" class="form-input" placeholder="7.0000" step="0.0001" min="0.0001" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditCurrencyModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="updateCurrency()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘åˆ†ç±»æ¨¡æ€æ¡† -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘åˆ†ç±»</h3>
                <button class="modal-close" onclick="closeEditCategoryModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»åç§°</label>
                        <input type="text" id="editCategoryName" class="form-input" placeholder="å¦‚: é¤é¥®è´¹" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆ†ç±»æè¿°</label>
                        <textarea id="editCategoryDescription" class="form-textarea" placeholder="æè¿°è¯¥åˆ†ç±»çš„ç”¨é€”..." rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditCategoryModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="updateCategory()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ¸…ç©ºæ•°æ®åº“æ¨¡æ€æ¡† -->
    <div class="modal" id="clearDatabaseModal">
        <div class="modal-content modal-danger">
            <div class="modal-header">
                <h3 class="modal-title">âš ï¸ æ¸…ç©ºæ•°æ®åº“</h3>
                <button class="modal-close" onclick="closeClearDatabaseModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
                    <ul>
                        <li>æ‰€æœ‰ç”¨æˆ·è´¦æˆ·</li>
                        <li>æ‰€æœ‰æŠ¥é”€è®°å½•</li>
                        <li>æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶</li>
                        <li>æ‰€æœ‰é€šçŸ¥è®°å½•</li>
                        <li>æ‰€æœ‰è´§å¸å’Œåˆ†ç±»é…ç½®</li>
                    </ul>
                    <p><strong>æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼</strong></p>
                </div>

                <form id="clearDatabaseForm">
                    <div class="form-group">
                        <label class="form-label">ç¡®è®¤æ–‡æœ¬</label>
                        <input type="text" id="clearConfirmation" class="form-input" 
                               placeholder="è¯·è¾“å…¥: CLEAR ALL DATA" required>
                        <small class="form-help">å¿…é¡»å‡†ç¡®è¾“å…¥ç¡®è®¤æ–‡æœ¬æ‰èƒ½æ‰§è¡Œæ“ä½œ</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="clearAdminPassword" class="form-input" 
                               placeholder="è¾“å…¥æ‚¨çš„ç®¡ç†å‘˜å¯†ç " required>
                        <small class="form-help">éœ€è¦éªŒè¯ç®¡ç†å‘˜èº«ä»½</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClearDatabaseModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="executeClearDatabase()" id="clearDatabaseBtn" disabled>
                    ç¡®è®¤æ¸…ç©ºæ•°æ®åº“
                </button>
            </div>
        </div>
    </div>

    <!-- é‡ç½®æ•°æ®åº“æ¨¡æ€æ¡† -->
    <div class="modal" id="resetDatabaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ”„ é‡ç½®æ•°æ®åº“</h3>
                <button class="modal-close" onclick="closeResetDatabaseModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡æ–°åˆ›å»ºé»˜è®¤é…ç½®ï¼š
                    <ul>
                        <li>é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼šadmin@company.com</li>
                        <li>é»˜è®¤å‘˜å·¥è´¦æˆ·ï¼šuser@company.com</li>
                        <li>10ç§å¸¸ç”¨è´§å¸é…ç½®</li>
                        <li>6ç§æŠ¥é”€åˆ†ç±»é…ç½®</li>
                    </ul>
                    <p>ç°æœ‰æ•°æ®å°†è¢«å®Œå…¨æ¸…é™¤ã€‚</p>
                </div>

                <form id="resetDatabaseForm">
                    <div class="form-group">
                        <label class="form-label">ç¡®è®¤æ–‡æœ¬</label>
                        <input type="text" id="resetConfirmation" class="form-input" 
                               placeholder="è¯·è¾“å…¥: RESET TO DEFAULTS" required>
                        <small class="form-help">å¿…é¡»å‡†ç¡®è¾“å…¥ç¡®è®¤æ–‡æœ¬æ‰èƒ½æ‰§è¡Œæ“ä½œ</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="resetAdminPassword" class="form-input" 
                               placeholder="è¾“å…¥æ‚¨çš„ç®¡ç†å‘˜å¯†ç " required>
                        <small class="form-help">éœ€è¦éªŒè¯ç®¡ç†å‘˜èº«ä»½</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeResetDatabaseModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="executeResetDatabase()" id="resetDatabaseBtn" disabled>
                    ç¡®è®¤é‡ç½®æ•°æ®åº“
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/advanced-filters.js') }}"></script>
    <script>
        let currencies = [];
        let filteredCurrencies = [];
        let currencyFilters = null;
        
        let categories = [];
        let filteredCategories = [];
        let categoryFilters = null;

        // ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
        
        // ç”¨æˆ·èœå•åˆ‡æ¢
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // åˆå§‹åŒ–è´§å¸ç­›é€‰
        function initCurrencyFilters() {
            currencyFilters = new AdvancedFilters('currencyFilters', {
                title: 'è´§å¸ç­›é€‰',
                collapsed: true,
                showQuickFilters: true,
                showSearch: true,
                fields: [
                    {
                        key: 'status',
                        label: 'çŠ¶æ€',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨çŠ¶æ€' },
                            { value: 'active', label: 'å·²å¯ç”¨' },
                            { value: 'inactive', label: 'å·²ç¦ç”¨' }
                        ]
                    },
                    {
                        key: 'exchangeRate',
                        label: 'æ±‡ç‡èŒƒå›´',
                        type: 'amountRange'
                    }
                ],
                quickFilters: [
                    { label: 'å·²å¯ç”¨', filters: { status: 'active' } },
                    { label: 'å·²ç¦ç”¨', filters: { status: 'inactive' } },
                    { label: 'é«˜æ±‡ç‡', filters: { exchangeRate: { min: '5' } } }
                ],
                onFilterChange: (filters) => {
                    applyCurrencyFilters(filters);
                }
            });
        }

        // åˆå§‹åŒ–åˆ†ç±»ç­›é€‰
        function initCategoryFilters() {
            categoryFilters = new AdvancedFilters('categoryFilters', {
                title: 'åˆ†ç±»ç­›é€‰',
                collapsed: true,
                showQuickFilters: true,
                showSearch: true,
                fields: [
                    {
                        key: 'status',
                        label: 'çŠ¶æ€',
                        type: 'select',
                        options: [
                            { value: '', label: 'å…¨éƒ¨çŠ¶æ€' },
                            { value: 'active', label: 'å·²å¯ç”¨' },
                            { value: 'inactive', label: 'å·²ç¦ç”¨' }
                        ]
                    }
                ],
                quickFilters: [
                    { label: 'å·²å¯ç”¨', filters: { status: 'active' } },
                    { label: 'å·²ç¦ç”¨', filters: { status: 'inactive' } }
                ],
                onFilterChange: (filters) => {
                    applyCategoryFilters(filters);
                }
            });
        }

        // åº”ç”¨è´§å¸ç­›é€‰
        function applyCurrencyFilters(filters) {
            filteredCurrencies = currencies.filter(currency => {
                // çŠ¶æ€ç­›é€‰
                if (filters.status) {
                    const isActive = currency.is_active;
                    if (filters.status === 'active' && !isActive) return false;
                    if (filters.status === 'inactive' && isActive) return false;
                }
                
                // æ±‡ç‡èŒƒå›´ç­›é€‰
                if (filters.exchangeRate) {
                    const rate = parseFloat(currency.exchange_rate);
                    if (filters.exchangeRate.min !== undefined && rate < parseFloat(filters.exchangeRate.min)) {
                        return false;
                    }
                    if (filters.exchangeRate.max !== undefined && rate > parseFloat(filters.exchangeRate.max)) {
                        return false;
                    }
                }
                
                // æœç´¢ç­›é€‰
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    const searchFields = [
                        currency.name,
                        currency.code,
                        currency.symbol
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderCurrencies(filteredCurrencies);
        }

        // åº”ç”¨åˆ†ç±»ç­›é€‰
        function applyCategoryFilters(filters) {
            filteredCategories = categories.filter(category => {
                // çŠ¶æ€ç­›é€‰
                if (filters.status) {
                    const isActive = category.is_active;
                    if (filters.status === 'active' && !isActive) return false;
                    if (filters.status === 'inactive' && isActive) return false;
                }
                
                // æœç´¢ç­›é€‰
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    const searchFields = [
                        category.name,
                        category.description
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderCategories(filteredCategories);
        }

        // åŠ è½½è´§å¸åˆ—è¡¨
        async function loadCurrencies() {
            const container = document.getElementById('currenciesList');
            
            try {
                currencies = await api.get('/api/admin/currencies');
                filteredCurrencies = currencies;
                
                if (currencies.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— è´§å¸é…ç½®</p></div>';
                    return;
                }
                
                renderCurrencies(currencies);
                
            } catch (error) {
                console.error('åŠ è½½è´§å¸åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // æ¸²æŸ“è´§å¸åˆ—è¡¨
        function renderCurrencies(data) {
            const container = document.getElementById('currenciesList');
            
            const html = data.map(currency => `
                <div class="admin-item ${!currency.is_active ? 'disabled' : ''}">
                    <div class="admin-item-info">
                        <h4>${currency.name} (${currency.code})</h4>
                        <p>ç¬¦å·: ${currency.symbol} | æ±‡ç‡: ${currency.exchange_rate}</p>
                        ${!currency.is_active ? '<p class="text-warning">âš ï¸ æ­¤è´§å¸å·²è¢«ç¦ç”¨</p>' : ''}
                    </div>
                    <div class="admin-item-actions">
                        ${currency.is_active ? 
                            `<button class="btn btn-secondary btn-sm" onclick="editCurrency(${currency.id})">ç¼–è¾‘</button>
                             <button class="btn btn-destructive btn-sm" onclick="deleteCurrency(${currency.id})">åˆ é™¤</button>` :
                            `<button class="btn btn-primary btn-sm" onclick="restoreCurrency(${currency.id})">æ¢å¤</button>
                             <button class="btn btn-secondary btn-sm" onclick="editCurrency(${currency.id})">æŸ¥çœ‹</button>`
                        }
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            const container = document.getElementById('categoriesList');
            
            try {
                categories = await api.get('/api/admin/categories');
                filteredCategories = categories;
                
                if (categories.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— åˆ†ç±»é…ç½®</p></div>';
                    return;
                }
                
                renderCategories(categories);
                
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories(data) {
            const container = document.getElementById('categoriesList');
            
            const html = data.map(category => `
                <div class="admin-item ${!category.is_active ? 'disabled' : ''}">
                    <div class="admin-item-info">
                        <h4>${category.name}</h4>
                        <p>${category.description || 'æ— æè¿°'}</p>
                        ${!category.is_active ? '<p class="text-warning">âš ï¸ æ­¤åˆ†ç±»å·²è¢«ç¦ç”¨</p>' : ''}
                    </div>
                    <div class="admin-item-actions">
                        ${category.is_active ? 
                            `<button class="btn btn-secondary btn-sm" onclick="editCategory(${category.id})">ç¼–è¾‘</button>
                             <button class="btn btn-destructive btn-sm" onclick="deleteCategory(${category.id})">åˆ é™¤</button>` :
                            `<button class="btn btn-primary btn-sm" onclick="restoreCategory(${category.id})">æ¢å¤</button>
                             <button class="btn btn-secondary btn-sm" onclick="editCategory(${category.id})">æŸ¥çœ‹</button>`
                        }
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ·»åŠ è´§å¸æ¨¡æ€æ¡†
        function showAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.add('show');
        }

        // å…³é—­æ·»åŠ è´§å¸æ¨¡æ€æ¡†
        function closeAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.remove('show');
            document.getElementById('addCurrencyForm').reset();
        }

        // æ·»åŠ è´§å¸
        async function addCurrency() {
            const code = document.getElementById('currencyCode').value.toUpperCase();
            const name = document.getElementById('currencyName').value;
            const symbol = document.getElementById('currencySymbol').value;
            const exchangeRate = document.getElementById('exchangeRate').value;
            
            if (!code || !name || !symbol || !exchangeRate) {
                utils.showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }
            
            try {
                await api.post('/api/admin/currencies', {
                    code, name, symbol, exchange_rate: parseFloat(exchangeRate)
                });
                
                utils.showMessage('è´§å¸æ·»åŠ æˆåŠŸ', 'success');
                closeAddCurrencyModal();
                loadCurrencies();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤è´§å¸
        async function deleteCurrency(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´§å¸å—ï¼Ÿå¦‚æœæœ‰ç›¸å…³æŠ¥é”€è®°å½•ï¼Œå°†è¢«ç¦ç”¨è€Œä¸æ˜¯åˆ é™¤ã€‚')) {
                return;
            }
            
            try {
                const result = await api.delete(`/api/admin/currencies/${id}`);
                utils.showMessage(result.message, 'success');
                loadCurrencies();
                
            } catch (error) {
                utils.showMessage(error.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ åˆ†ç±»æ¨¡æ€æ¡†
        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('show');
        }

        // å…³é—­æ·»åŠ åˆ†ç±»æ¨¡æ€æ¡†
        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('show');
            document.getElementById('addCategoryForm').reset();
        }

        // æ·»åŠ åˆ†ç±»
        async function addCategory() {
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;
            
            if (!name) {
                utils.showMessage('è¯·å¡«å†™åˆ†ç±»åç§°', 'error');
                return;
            }
            
            try {
                await api.post('/api/admin/categories', {
                    name, description
                });
                
                utils.showMessage('åˆ†ç±»æ·»åŠ æˆåŠŸ', 'success');
                closeAddCategoryModal();
                loadCategories();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿå¦‚æœæœ‰ç›¸å…³æŠ¥é”€è®°å½•ï¼Œå°†è¢«ç¦ç”¨è€Œä¸æ˜¯åˆ é™¤ã€‚')) {
                return;
            }
            
            try {
                const result = await api.delete(`/api/admin/categories/${id}`);
                utils.showMessage(result.message, 'success');
                loadCategories();
                
            } catch (error) {
                utils.showMessage(error.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ¢å¤è´§å¸
        async function restoreCurrency(id) {
            if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªè´§å¸å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await api.post(`/api/admin/currencies/${id}/restore`);
                utils.showMessage(result.message, 'success');
                loadCurrencies();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ¢å¤å¤±è´¥', 'error');
            }
        }

        // æ¢å¤åˆ†ç±»
        async function restoreCategory(id) {
            if (!confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await api.post(`/api/admin/categories/${id}/restore`);
                utils.showMessage(result.message, 'success');
                loadCategories();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ¢å¤å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘è´§å¸
        async function editCurrency(id) {
            try {
                const currency = currencies.find(c => c.id === id);
                
                if (!currency) {
                    utils.showMessage('è´§å¸ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('editCurrencyId').value = currency.id;
                document.getElementById('editCurrencyCode').value = currency.code;
                document.getElementById('editCurrencyName').value = currency.name;
                document.getElementById('editCurrencySymbol').value = currency.symbol;
                document.getElementById('editExchangeRate').value = currency.exchange_rate;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editCurrencyModal').classList.add('show');
                
            } catch (error) {
                utils.showMessage('åŠ è½½è´§å¸ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // å…³é—­ç¼–è¾‘è´§å¸æ¨¡æ€æ¡†
        function closeEditCurrencyModal() {
            document.getElementById('editCurrencyModal').classList.remove('show');
            document.getElementById('editCurrencyForm').reset();
        }

        // æ›´æ–°è´§å¸
        async function updateCurrency() {
            const id = document.getElementById('editCurrencyId').value;
            const name = document.getElementById('editCurrencyName').value;
            const symbol = document.getElementById('editCurrencySymbol').value;
            const exchangeRate = document.getElementById('editExchangeRate').value;
            
            if (!name || !symbol || !exchangeRate) {
                utils.showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }
            
            try {
                await api.put(`/api/admin/currencies/${id}`, {
                    name, symbol, exchange_rate: parseFloat(exchangeRate)
                });
                
                utils.showMessage('è´§å¸æ›´æ–°æˆåŠŸ', 'success');
                closeEditCurrencyModal();
                loadCurrencies();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘åˆ†ç±»
        async function editCategory(id) {
            try {
                const category = categories.find(c => c.id === id);
                
                if (!category) {
                    utils.showMessage('åˆ†ç±»ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('editCategoryId').value = category.id;
                document.getElementById('editCategoryName').value = category.name;
                document.getElementById('editCategoryDescription').value = category.description || '';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editCategoryModal').classList.add('show');
                
            } catch (error) {
                utils.showMessage('åŠ è½½åˆ†ç±»ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // å…³é—­ç¼–è¾‘åˆ†ç±»æ¨¡æ€æ¡†
        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').classList.remove('show');
            document.getElementById('editCategoryForm').reset();
        }

        // æ›´æ–°åˆ†ç±»
        async function updateCategory() {
            const id = document.getElementById('editCategoryId').value;
            const name = document.getElementById('editCategoryName').value;
            const description = document.getElementById('editCategoryDescription').value;
            
            if (!name) {
                utils.showMessage('è¯·å¡«å†™åˆ†ç±»åç§°', 'error');
                return;
            }
            
            try {
                await api.put(`/api/admin/categories/${id}`, {
                    name, description
                });
                
                utils.showMessage('åˆ†ç±»æ›´æ–°æˆåŠŸ', 'success');
                closeEditCategoryModal();
                loadCategories();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // æ•°æ®åº“ç®¡ç†åŠŸèƒ½
        let databaseStats = {};

        // å¯¼å…¥æŠ¥é”€ç±»å‹
        async function importExpenseCategories() {
            const button = document.getElementById('importCategoriesBtn');
            const originalText = button.innerHTML;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                button.disabled = true;
                button.innerHTML = `
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    å¯¼å…¥ä¸­...
                `;
                
                const response = await api.post('/api/admin/import-categories');
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                utils.showMessage(
                    `å¯¼å…¥æˆåŠŸï¼æ–°å¢ ${response.imported} ä¸ªï¼Œæ›´æ–° ${response.updated} ä¸ªï¼Œè·³è¿‡ ${response.skipped} ä¸ª`, 
                    'success'
                );
                
                // åˆ·æ–°æ•°æ®åº“ç»Ÿè®¡
                await refreshDatabaseStats();
                
            } catch (error) {
                utils.showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // åŠ è½½æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
        async function refreshDatabaseStats() {
            try {
                const response = await api.get('/api/admin/database-stats');
                databaseStats = response.stats;
                renderDatabaseStats();
            } catch (error) {
                utils.showMessage('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
        function renderDatabaseStats() {
            const container = document.getElementById('databaseStats');
            const formatFileSize = (bytes) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.users || 0}</div>
                            <div class="stat-label">ç”¨æˆ·</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ“‹</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.expenses || 0}</div>
                            <div class="stat-label">æŠ¥é”€è®°å½•</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.expense_files || 0}</div>
                            <div class="stat-label">é™„ä»¶è®°å½•</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ””</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.notifications || 0}</div>
                            <div class="stat-label">é€šçŸ¥</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ’±</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.currencies || 0}</div>
                            <div class="stat-label">è´§å¸ç±»å‹</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ·ï¸</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.categories || 0}</div>
                            <div class="stat-label">åˆ†ç±»</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ“„</div>
                        <div class="stat-content">
                            <div class="stat-value">${databaseStats.uploaded_files || 0}</div>
                            <div class="stat-label">ä¸Šä¼ æ–‡ä»¶</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">ğŸ’¾</div>
                        <div class="stat-content">
                            <div class="stat-value">${formatFileSize(databaseStats.total_file_size || 0)}</div>
                            <div class="stat-label">æ–‡ä»¶å¤§å°</div>
                        </div>
                    </div>
                </div>
                <div class="stats-summary">
                    <p><strong>æ€»è®°å½•æ•°ï¼š</strong>${databaseStats.total_records || 0} æ¡</p>
                    <p><small>æœ€åæ›´æ–°ï¼š${new Date().toLocaleString()}</small></p>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ¸…ç©ºæ•°æ®åº“æ¨¡æ€æ¡†
        function showClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').classList.add('show');
        }

        // å…³é—­æ¸…ç©ºæ•°æ®åº“æ¨¡æ€æ¡†
        function closeClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').classList.remove('show');
            document.getElementById('clearDatabaseForm').reset();
            document.getElementById('clearDatabaseBtn').disabled = true;
        }

        // æ˜¾ç¤ºé‡ç½®æ•°æ®åº“æ¨¡æ€æ¡†
        function showResetDatabaseModal() {
            document.getElementById('resetDatabaseModal').classList.add('show');
        }

        // å…³é—­é‡ç½®æ•°æ®åº“æ¨¡æ€æ¡†
        function closeResetDatabaseModal() {
            document.getElementById('resetDatabaseModal').classList.remove('show');
            document.getElementById('resetDatabaseForm').reset();
            document.getElementById('resetDatabaseBtn').disabled = true;
        }

        // æ‰§è¡Œæ¸…ç©ºæ•°æ®åº“
        async function executeClearDatabase() {
            const confirmation = document.getElementById('clearConfirmation').value;
            const password = document.getElementById('clearAdminPassword').value;

            if (confirmation !== 'CLEAR ALL DATA') {
                utils.showMessage('ç¡®è®¤æ–‡æœ¬ä¸æ­£ç¡®', 'error');
                return;
            }

            if (!password) {
                utils.showMessage('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ', 'error');
                return;
            }

            try {
                const confirmAgain = confirm('æœ€åç¡®è®¤ï¼šæ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼');
                if (!confirmAgain) return;

                const response = await api.post('/api/admin/clear-database', {
                    confirmation: confirmation,
                    admin_password: password
                });

                utils.showMessage('æ•°æ®åº“å·²å®Œå…¨æ¸…ç©º', 'success');
                closeClearDatabaseModal();
                
                // æ˜¾ç¤ºæ¸…ç©ºç»“æœ
                setTimeout(() => {
                    alert('æ¸…ç©ºå®Œæˆï¼è¯¦æƒ…ï¼š\\n' + response.clear_results.join('\\n'));
                    // é¡µé¢å°†ä¼šå› ä¸ºsessionå¤±æ•ˆè€Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = '/';
                }, 1000);

            } catch (error) {
                utils.showMessage('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰§è¡Œé‡ç½®æ•°æ®åº“
        async function executeResetDatabase() {
            const confirmation = document.getElementById('resetConfirmation').value;
            const password = document.getElementById('resetAdminPassword').value;

            if (confirmation !== 'RESET TO DEFAULTS') {
                utils.showMessage('ç¡®è®¤æ–‡æœ¬ä¸æ­£ç¡®', 'error');
                return;
            }

            if (!password) {
                utils.showMessage('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ', 'error');
                return;
            }

            try {
                const confirmAgain = confirm('æœ€åç¡®è®¤ï¼šæ‚¨ç¡®å®šè¦é‡ç½®æ•°æ®åº“åˆ°é»˜è®¤çŠ¶æ€å—ï¼Ÿ');
                if (!confirmAgain) return;

                const response = await api.post('/api/admin/reset-to-defaults', {
                    confirmation: confirmation,
                    admin_password: password
                });

                utils.showMessage('æ•°æ®åº“å·²é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€', 'success');
                closeResetDatabaseModal();
                
                setTimeout(() => {
                    alert('é‡ç½®å®Œæˆï¼å·²åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜å’Œå‘˜å·¥è´¦æˆ·ï¼Œä»¥åŠåŸºç¡€é…ç½®æ•°æ®ã€‚');
                    // é‡æ–°ç™»å½•
                    window.location.href = '/';
                }, 1000);

            } catch (error) {
                utils.showMessage('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç”¨æˆ·ç®¡ç†åŠŸèƒ½
        let users = [];
        let filteredUsers = [];
        let currentUserId = {{ session.user_id if session.user_id else 'null' }};

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const container = document.getElementById('usersList');
            
            try {
                users = await api.get('/api/admin/users');
                filteredUsers = users;
                
                if (users.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— ç”¨æˆ·</p></div>';
                    return;
                }
                
                renderUsers(filteredUsers);
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                container.innerHTML = '<div class="empty-state error"><p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p></div>';
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(userList) {
            const container = document.getElementById('usersList');
            
            const html = userList.map(user => {
                const roleIcon = user.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
                const roleName = user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
                const roleClass = user.role === 'admin' ? 'admin' : 'user';
                
                return `
                    <div class="admin-item">
                        <div class="item-info">
                            <div class="item-main">
                                <span class="item-name">${roleIcon} ${user.username}</span>
                                <div class="item-details">
                                    <span class="item-detail">${user.email}</span>
                                    <span class="badge badge-${roleClass}">${roleName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editUser(${user.id})">ç¼–è¾‘</button>
                            ${user.id !== ${JSON.stringify(currentUserId)} ? `<button class="btn btn-sm btn-destructive" onclick="deleteUser(${user.id}, '${user.username}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ç­›é€‰ç”¨æˆ·
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            
            filteredUsers = users.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm) || 
                                    user.email.toLowerCase().includes(searchTerm);
                const matchesRole = !roleFilter || user.role === roleFilter;
                
                return matchesSearch && matchesRole;
            });
            
            renderUsers(filteredUsers);
        }

        // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('show');
        }

        // å…³é—­æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('show');
            document.getElementById('addUserForm').reset();
        }

        // æ·»åŠ ç”¨æˆ·
        async function addUser() {
            const username = document.getElementById('newUserUsername').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const passwordConfirm = document.getElementById('newUserPasswordConfirm').value;
            const role = document.getElementById('newUserRole').value;
            
            // éªŒè¯è¾“å…¥
            if (!username || !email || !password) {
                utils.showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                utils.showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            if (password.length < 6) {
                utils.showMessage('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }
            
            try {
                await api.post('/api/admin/users', {
                    username, email, password, role
                });
                
                utils.showMessage('ç”¨æˆ·æ·»åŠ æˆåŠŸ', 'success');
                closeAddUserModal();
                loadUsers();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // ç¼–è¾‘ç”¨æˆ·
        async function editUser(id) {
            try {
                const user = users.find(u => u.id === id);
                if (!user) return;
                
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUserUsername').value = user.username;
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserRole').value = user.role;
                document.getElementById('editUserPassword').value = '';
                document.getElementById('editUserPasswordConfirm').value = '';
                
                document.getElementById('editUserModal').classList.add('show');
                
            } catch (error) {
                utils.showMessage(error.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // å…³é—­ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            document.getElementById('editUserForm').reset();
        }

        // æ›´æ–°ç”¨æˆ·
        async function updateUser() {
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('editUserUsername').value;
            const email = document.getElementById('editUserEmail').value;
            const password = document.getElementById('editUserPassword').value;
            const passwordConfirm = document.getElementById('editUserPasswordConfirm').value;
            const role = document.getElementById('editUserRole').value;
            
            // éªŒè¯è¾“å…¥
            if (!username || !email) {
                utils.showMessage('ç”¨æˆ·åå’Œé‚®ç®±ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            // å¦‚æœè¾“å…¥äº†å¯†ç ï¼ŒéªŒè¯å¯†ç 
            if (password && password !== passwordConfirm) {
                utils.showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            if (password && password.length < 6) {
                utils.showMessage('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }
            
            try {
                const updateData = { username, email, role };
                if (password) {
                    updateData.password = password;
                }
                
                await api.put(`/api/admin/users/${id}`, updateData);
                
                utils.showMessage('ç”¨æˆ·æ›´æ–°æˆåŠŸ', 'success');
                closeEditUserModal();
                loadUsers();
                
            } catch (error) {
                utils.showMessage(error.message || 'æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(id, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·"${username}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                await api.delete(`/api/admin/users/${id}`);
                utils.showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                loadUsers();
                
            } catch (error) {
                utils.showMessage(error.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrencies();
            loadCategories();
            loadUsers();
            refreshDatabaseStats();
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    const dropdown = document.getElementById('userDropdown');
                    dropdown.classList.remove('show');
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('addCurrencyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddCurrencyModal();
                }
            });

            document.getElementById('addCategoryModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddCategoryModal();
                }
            });

            document.getElementById('addUserModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddUserModal();
                }
            });

            document.getElementById('editUserModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditUserModal();
                }
            });

            document.getElementById('editCurrencyModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditCurrencyModal();
                }
            });

            document.getElementById('editCategoryModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditCategoryModal();
                }
            });

            // æ•°æ®åº“ç®¡ç†æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('clearDatabaseModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeClearDatabaseModal();
                }
            });

            document.getElementById('resetDatabaseModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeResetDatabaseModal();
                }
            });

            // è¡¨å•éªŒè¯ - æ¸…ç©ºæ•°æ®åº“
            const clearConfirmation = document.getElementById('clearConfirmation');
            const clearPassword = document.getElementById('clearAdminPassword');
            const clearBtn = document.getElementById('clearDatabaseBtn');

            function validateClearForm() {
                const isValid = clearConfirmation.value === 'CLEAR ALL DATA' && clearPassword.value.trim() !== '';
                clearBtn.disabled = !isValid;
            }

            clearConfirmation.addEventListener('input', validateClearForm);
            clearPassword.addEventListener('input', validateClearForm);

            // è¡¨å•éªŒè¯ - é‡ç½®æ•°æ®åº“
            const resetConfirmation = document.getElementById('resetConfirmation');
            const resetPassword = document.getElementById('resetAdminPassword');
            const resetBtn = document.getElementById('resetDatabaseBtn');

            function validateResetForm() {
                const isValid = resetConfirmation.value === 'RESET TO DEFAULTS' && resetPassword.value.trim() !== '';
                resetBtn.disabled = !isValid;
            }

            resetConfirmation.addEventListener('input', validateResetForm);
            resetPassword.addEventListener('input', validateResetForm);
        });
    </script>
</body>
</html>